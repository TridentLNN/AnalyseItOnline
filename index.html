<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Content Security Policy to enhance security -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://cors-anywhere.herokuapp.com https://generativelanguage.googleapis.com https://api.abuseipdb.com https://www.virustotal.com https://www.hybrid-analysis.com *;
        img-src 'self' data:;
        object-src 'none';
        frame-ancestors 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse It!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-flow-renderer@10.3.17/dist/umd/index.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@500&family=IBM+Plex+Sans:wght@400;500;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Default to Slate Theme */
            --bg-primary: #0f172a;
            --bg-secondary: rgba(30, 41, 59, 0.6);
            --bg-tertiary: rgba(30, 41, 59, 0.5);
            --bg-modal: rgba(45, 55, 72, 0.4);
            --bg-interactive: rgba(255, 255, 255, 0.1);
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --text-accent: #38bdf8;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-primary: #0ea5e9; /* cyan-500 */
            --accent-positive: #22c55e; /* green-500 */
            --accent-negative: #ef4444; /* red-500 */
            --accent-warning: #f97316; /* orange-500 */
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        [data-theme='light'] {
            --bg-primary: #f1f5f9;
            --bg-secondary: #ffffff;
            --bg-tertiary: rgba(255, 255, 255, 0.7);
            --bg-modal: rgba(255, 255, 255, 0.6);
            --bg-interactive: rgba(0, 0, 0, 0.05);
            --text-main: #1e293b;
            --text-dim: #475569;
            --text-accent: #0284c7;
            --border-color: rgba(0, 0, 0, 0.1);
            --accent-primary: #0ea5e9;
            --accent-positive: #16a34a;
            --accent-negative: #dc2626;
            --accent-warning: #ea580c;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme='cyberpunk'] {
            --bg-primary: #0d0124;
            --bg-secondary: rgba(24, 0, 61, 0.6);
            --bg-tertiary: rgba(24, 0, 61, 0.5);
            --bg-modal: rgba(36, 0, 70, 0.4);
            --bg-interactive: rgba(255, 0, 255, 0.1);
            --text-main: #f0f;
            --text-dim: #a78bfa;
            --text-accent: #0ff;
            --border-color: rgba(0, 255, 255, 0.2);
            --accent-primary: #0ff;
            --accent-positive: #0f0;
            --accent-negative: #ff073a;
            --accent-warning: #fdfc74;
            --shadow-color: rgba(0, 255, 255, 0.2);
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--bg-primary);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }
        .font-mono { font-family: 'IBM Plex Mono', monospace; }
        .font-digital { font-family: 'Orbitron', sans-serif; }

        #interactive-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; transition: filter 0.4s ease-out, opacity 0.5s ease-out; }
        #root { position: relative; z-index: 1; }

        .glass-card { background: var(--bg-tertiary); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; transition: box-shadow 0.3s ease; }
        .glass-card:hover { box-shadow: 0 10px 20px var(--shadow-color), 0 0 40px var(--shadow-color); }
        .card-content { transition: transform 0.3s ease; }
        .glass-card:hover .card-content { transform: scale(1.05); }

        .ios-modal-glass { background: var(--bg-modal); -webkit-backdrop-filter: blur(48px); backdrop-filter: blur(48px); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px var(--shadow-color); }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        .glowing-panel { position: relative; border-radius: 1rem; background: var(--bg-secondary); border: 1px solid var(--border-color); overflow: hidden; padding: 0.5rem; }
        .glowing-panel::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle 500px at var(--mouse-x) var(--mouse-y), var(--shadow-color), transparent 50%); border-radius: inherit; z-index: 1; opacity: 0; transition: opacity 0.3s ease-out; }
        .glowing-panel:hover::before { opacity: 1; }
        .panel-content-wrapper { position: relative; z-index: 2; }
        
        .reputation-tooltip {
            visibility: hidden; opacity: 0; transition: opacity 0.2s, visibility 0.2s; pointer-events: none;
        }
        .reputation-checker:hover .reputation-tooltip {
            visibility: visible; opacity: 1;
        }
        .matrix-tooltip {
            visibility: hidden; opacity: 0; transition: opacity 0.2s, visibility 0.2s; pointer-events: none;
            background: var(--bg-primary); /* Opaque background */
            font-size: 1rem; /* text-base */
            line-height: 1.5rem;
            z-index: 9999; /* Ensure this is on top of other modal elements */
            padding: 1rem;
            width: 22rem; /* 352px */
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 10px 20px var(--shadow-color);
        }
        .matrix-cell:hover .matrix-tooltip {
            visibility: visible; opacity: 1;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fade-in-scale { 0% { opacity: 0; transform: scale(0.9); } 70% { opacity: 1; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slide-up { 0% { transform: translateY(100%); } 80% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        @keyframes slide-in-left { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        @keyframes slide-out-left { from { transform: translateX(0); } to { transform: translateX(-100%); } }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-fade-in-scale { animation: fade-in-scale 0.4s cubic-bezier(0.25, 1, 0.5, 1.1) forwards; }
        .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .menu-entering { animation: slide-in-left 0.3s ease-out forwards; }
        .menu-exiting { animation: slide-out-left 0.3s ease-in forwards; }
    </style>
</head>
<body data-theme="slate">
    <canvas id="interactive-background"></canvas>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        function runApplication() {
            const { useState, useEffect, useMemo, useRef, Fragment, useCallback } = React;
            const { jsPDF } = window.jspdf;

            // --- Custom Hooks ---
            function useDebounce(value, delay) {
                const [debouncedValue, setDebouncedValue] = useState(value);
                useEffect(() => {
                    const handler = setTimeout(() => {
                        setDebouncedValue(value);
                    }, delay);
                    return () => {
                        clearTimeout(handler);
                    };
                }, [value, delay]);
                return debouncedValue;
            }
            
            function useAnimatedCounter(endValue, duration = 1500) {
                const [count, setCount] = useState(0);
                const frameRate = 1000 / 60;
                const totalFrames = Math.round(duration / frameRate);

                useEffect(() => {
                    let frame = 0;
                    const counter = setInterval(() => {
                        frame++;
                        const progress = frame / totalFrames;
                        // Ease-out function for a smoother animation
                        const easeOutProgress = 1 - Math.pow(1 - progress, 3);
                        const currentCount = Math.round(endValue * easeOutProgress);
                        
                        setCount(currentCount);

                        if (frame === totalFrames) {
                            clearInterval(counter);
                            setCount(endValue); // Ensure it ends on the exact value
                        }
                    }, frameRate);

                    return () => clearInterval(counter);
                }, [endValue, duration]);

                return count;
            }


            // --- SVG Icons ---
            const Icon = ({ path, className = "w-6 h-6", spin = false }) => (
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} ${spin ? 'animate-spin' : ''}`}>
                    <path d={path} />
                </svg>
            );
            const ICONS = {
                Shield: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",
                FileCode: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M9 18H6 M12 18H9 M9 15H6 M12 15H9 M14 2v6h6",
                Globe: "M22 12A10 10 0 1 1 12 2a10 10 0 0 1 10 10z M2 12h20 M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z",
                Menu: "M3 12h18M3 6h18M3 18h18",
                Settings: "M12.22 2h-0.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l-.15-.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 1 0 6 3 3 0 0 1 0-6z",
                X: "M18 6L6 18 M6 6l12 12",
                ExternalLink: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6 M15 3h6v6 M10 14L21 3",
                ShieldCheck: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z M9 12l2 2 4-4",
                ShieldOff: "M19.69 14a6.9 6.9 0 0 0 .31-2V5l-8-3-3.36 1.26 M6.53 6.53L4 8v4c0 6 8 10 8 10a10.3 10.3 0 0 0 5.44-2.22 M2 2l20 20",
                Skull: "M8 1a2 2 0 0 1 2 2v2H6V3a2 2 0 0 1 2-2z M12 2.5A2.5 2.5 0 0 0 9.5 5h5A2.5 2.5 0 0 0 12 2.5z M8 10a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2h-2.5a.5.5 0 0 1-.5-.5V9a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 0-.5.5v.5a.5.5 0 0 1-.5.5H8z",
                Plus: "M12 5v14 M5 12h14",
                Info: "M12 22A10 10 0 1 1 12 2a10 10 0 0 1 10 10z M12 8v4 M12 16h.01",
                BrainCircuit: "M12 2a10 10 0 0 0-10 10c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.89 1.52 2.34 1.08 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92a3.87 3.87 0 0 1 1.03-2.71c-.1-.25-.45-1.28.1-2.68c0 0 .84-.27 2.75 1.02a9.58 9.58 0 0 1 5 0c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.4.2 2.43.1 2.68a3.87 3.87 0 0 1 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5A10 10 0 0 0 22 12A10 10 0 0 0 12 2z",
                Search: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16z M21 21l-4.35-4.35",
                Loader: "M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83",
                Copy: "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",
                Check: "M20 6L9 17l-5-5",
                Palette: "M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z",
                UploadCloud: "M16 16l-4-4-4 4M12 12v9M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3",
                Bot: "M12 8V4H8v4H4v8h4v4h8v-4h4V8h-4z M8 14H6v-4h2v4zm6 0h-4v-4h4v4zm4 0h-2v-4h2v4z",
                List: "M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01",
                Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
                Share2: "M18 8a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM6 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM18 20a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98",
                Maximize: "M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
            };

            // --- VT Detection Processing Logic ---
            const engineTiersConfig = {
                'top': { weight: 10, engines: ['Kaspersky', 'BitDefender', 'Symantec', 'ESET-NOD32', 'Avast'] },
                'mid-high': { weight: 7, engines: [ 'McAfee', 'TrendMicro', 'F-Secure', 'Paloalto', 'Elastic', 'Microsoft'] },
                'untrusted': { weight: 0.0, engines: ['NanoAV', 'Google', 'Zillya', 'Rising'] },
                'mid': { weight: 2 } // Default
            };
            const getEngineTier = (engineName) => {
                if (engineTiersConfig.top.engines.includes(engineName)) return 1;
                if (engineTiersConfig['mid-high'].engines.includes(engineName)) return 2;
                if (engineTiersConfig.untrusted.engines.includes(engineName)) return 4;
                return 3; // Default 'mid' tier
            };
            const getEngineWeight = (engineName) => {
                if (engineTiersConfig.top.engines.includes(engineName)) return engineTiersConfig.top.weight;
                if (engineTiersConfig['mid-high'].engines.includes(engineName)) return engineTiersConfig['mid-high'].weight;
                if (engineTiersConfig.untrusted.engines.includes(engineName)) return engineTiersConfig.untrusted.weight;
                return engineTiersConfig.mid.weight;
            };
            const calculateVtThreatScore = (detectionResults) => {
                if (!detectionResults) return { score: 0, comment: "No data available." };
                let actualScore = 0;
                let maxPossibleScore = 0;
                Object.entries(detectionResults).forEach(([engine, res]) => {
                    const weight = getEngineWeight(engine);
                    maxPossibleScore += weight;
                    if (res.category === 'malicious') {
                        actualScore += weight;
                    }
                });
                const score = maxPossibleScore > 0 ? (actualScore / maxPossibleScore) * 100 : 0;
                let comment = "No malicious detections from any engine. In this case the sample could be a low-key zero-day. Further analysis of digital signature and behaviour is recommended.";
                if (score > 80) comment = "There is a very high probability that this file is known and prolific malware, even without behavioural analys.";
                else if (score > 40) comment = "This file is malicious/suspicious and your best course of action is to either double-check the behaviour report, or to remove the file. Instead of looking at individual detections, look at the Overall Threat Factor.";
                else if (score > 15) comment = "There are indications that this file could be malware. Behavioural and AI analysis are necessary. Look at the Overall Threat Factor";
                else if (score > 0) comment = "Few, mostly lower-tier detections. This may be a false positive or a very low-risk file, but a non-zero score warrants attention. Behavioural and AI analysis are highly recommended - look at the Ovreall Threat Factor";
                return { score: Math.round(score), comment };
            };
            const processDetections = (detectionResults, deduplicate = true) => {
                const allDetections = Object.entries(detectionResults ?? {})
                    .filter(([_, res]) => res.category === 'malicious')
                    .map(([engine, res]) => ({ engine, result: res.result, tier: getEngineTier(engine) }))
                    .sort((a, b) => {
                        if (a.tier !== b.tier) return a.tier - b.tier; // Sort by tier first (1 is best)
                        return b.result.length - a.result.length; // Then by result length, descending
                    });
                if (!deduplicate) return { processedList: allDetections, originalCount: allDetections.length };
                const processedList = [];
                allDetections.forEach(currentDetection => {
                    const isSubstring = processedList.some(addedDetection => addedDetection.result.includes(currentDetection.result));
                    if (!isSubstring) processedList.push(currentDetection);
                });
                return { processedList, originalCount: allDetections.length };
            };

            // --- Main App Component ---
            function App() {
                // Core State
                const [productName, setProductName] = useState(() => localStorage.getItem('productName') || 'Analyse It!');
                const [urls, setUrls] = useState(() => JSON.parse(localStorage.getItem('urls') || '[]'));
                const [isSettingsOpen, setIsSettingsOpen] = useState(false);
                const [selectedUrl, setSelectedUrl] = useState(null);
                const [iocs, setIocs] = useState(() => JSON.parse(localStorage.getItem('iocs') || '[]'));

                // API & Scanning State
                const [geminiApiKey, setGeminiApiKey] = useState(() => sessionStorage.getItem('geminiApiKey') || '');
                const [virusTotalApiKey, setVirusTotalApiKey] = useState(() => sessionStorage.getItem('virusTotalApiKey') || '');
                const [abuseIpDbApiKey, setAbuseIpDbApiKey] = useState(() => sessionStorage.getItem('abuseIpDbApiKey') || '');
                const [hybridAnalysisApiKey, setHybridAnalysisApiKey] = useState(() => sessionStorage.getItem('hybridAnalysisApiKey') || '');
                const [cloudflareWorkerUrl, setCloudflareWorkerUrl] = useState(() => localStorage.getItem('cloudflareWorkerUrl') || '');
                const [vtScanThreshold, setVtScanThreshold] = useState(() => parseInt(localStorage.getItem('vtScanThreshold') || '1', 10));
                const [scanQueue, setScanQueue] = useState([]);
                const [isScanning, setIsScanning] = useState(false);
                
                // New Settings State
                const [vtDeduplication, setVtDeduplication] = useState(() => localStorage.getItem('vtDeduplication') !== 'false'); // Default true
                const [vtInterpretation, setVtInterpretation] = useState(() => localStorage.getItem('vtInterpretation') !== 'false'); // Default true
                const [aiBehaviourScoring, setAiBehaviourScoring] = useState(() => localStorage.getItem('aiBehaviourScoring') !== 'false'); // Default true
                const [defaultAiResponseLength, setDefaultAiResponseLength] = useState(() => localStorage.getItem('defaultAiResponseLength') || 'expert');
                const [animationsEnabled, setAnimationsEnabled] = useState(() => localStorage.getItem('animationsEnabled') !== 'false');

                // Hash Lookup State & Modal Persistence State
                const [hashResult, setHashResult] = useState(null);
                const [hybridAnalysisResult, setHybridAnalysisResult] = useState(null);
                const [isHashLoading, setIsHashLoading] = useState(false);
                const [isFileAnalysisModalOpen, setIsFileAnalysisModalOpen] = useState(false);
                const [fileAiAnalysisResult, setFileAiAnalysisResult] = useState("");
                const [isFileAiLoading, setIsFileAiLoading] = useState(false);
                const [mitreMatrixData, setMitreMatrixData] = useState(null);
                const [isMitreLoading, setIsMitreLoading] = useState(false);
                const [behaviourRiskScores, setBehaviourRiskScores] = useState(null);
                const [isScoringBehaviour, setIsScoringBehaviour] = useState(false);
                const [isSourcePromptOpen, setIsSourcePromptOpen] = useState(false);
                const [pendingHash, setPendingHash] = useState(null);
                const [currentSampleSource, setCurrentSampleSource] = useState('other');
                const [apiCache, setApiCache] = useState({}); // Session-based cache for API results

                // CADY State
                const [isCadyOpen, setIsCadyOpen] = useState(false);

                // Analysis State
                const [effectiveness, setEffectiveness] = useState(null);
                const [isAnalysisOpen, setIsAnalysisOpen] = useState(false);
                const [analysisResult, setAnalysisResult] = useState("");
                const [isAiLoading, setIsAiLoading] = useState(false);
                
                // UI State
                const [toast, setToast] = useState(null);
                const [activeView, setActiveView] = useState('web');
                const [isMenuOpen, setIsMenuOpen] = useState(false);
                const [activeFilter, setActiveFilter] = useState('all');
                const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'slate');

                const isModalOpen = isSettingsOpen || selectedUrl !== null || isAnalysisOpen || isFileAnalysisModalOpen || isCadyOpen || isSourcePromptOpen;
                const timeoutRef = useRef(null);
                
                const getProxyUrl = () => {
                    return cloudflareWorkerUrl.trim() ? cloudflareWorkerUrl.trim() : 'https://cors-anywhere.herokuapp.com/';
                }

                // --- Effects ---
                useEffect(() => {
                    const canvas = document.getElementById('interactive-background');
                    if (!canvas || !animationsEnabled) {
                        if(canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }
                        return;
                    };
                    const ctx = canvas.getContext('2d');
                    let animationFrameId;

                    if (activeView === 'file' || activeView === 'ioc') {
                        canvas.style.opacity = 0;
                        setTimeout(() => {
                            if (canvas.style.opacity === '0') {
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                            }
                        }, 500);
                        return;
                    } else {
                        canvas.style.opacity = 1;
                    }

                    class Ball { constructor(x, y, radius, color) { this.x = x; this.y = y; this.radius = radius; this.color = color; this.vx = (Math.random() - 0.5) * 0.5; this.vy = (Math.random() - 0.5) * 0.5; } update(width, height) { if (this.x > width + 50 || this.x < -50) this.vx = -this.vx; if (this.y > height + 50 || this.y < -50) this.vy = -this.vy; this.x += this.vx; this.y += this.vy; } draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); } }
                    let balls = [];
                    const resizeCanvas = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; balls = [ new Ball(Math.random() * canvas.width, Math.random() * canvas.height, 100, 'rgba(67, 56, 202, 0.25)'), new Ball(Math.random() * canvas.width, Math.random() * canvas.height, 120, 'rgba(147, 51, 234, 0.25)'), new Ball(Math.random() * canvas.width, Math.random() * canvas.height, 110, 'rgba(219, 39, 119, 0.25)'), new Ball(Math.random() * canvas.width, Math.random() * canvas.height, 90, 'rgba(20, 184, 166, 0.25)'), ]; };
                    resizeCanvas();
                    window.addEventListener('resize', resizeCanvas);
                    const animate = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); balls.forEach(ball => { ball.update(canvas.width, canvas.height); ball.draw(); }); animationFrameId = requestAnimationFrame(animate); };
                    animate();
                    
                    return () => {
                        window.removeEventListener('resize', resizeCanvas);
                        cancelAnimationFrame(animationFrameId);
                    };
                }, [activeView, animationsEnabled]);

                useEffect(() => {
                    const canvas = document.getElementById('interactive-background'); if (!canvas) return;
                    if (isModalOpen || isMenuOpen) { canvas.style.filter = 'contrast(20) blur(24px)'; } else { canvas.style.filter = 'contrast(25) blur(10px)'; }
                }, [isModalOpen, isMenuOpen]);

                useEffect(() => { 
                    document.body.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                }, [theme]);

                // Use sessionStorage for API keys for better security
                useEffect(() => { sessionStorage.setItem('geminiApiKey', geminiApiKey); }, [geminiApiKey]);
                useEffect(() => { sessionStorage.setItem('virusTotalApiKey', virusTotalApiKey); }, [virusTotalApiKey]);
                useEffect(() => { sessionStorage.setItem('abuseIpDbApiKey', abuseIpDbApiKey); }, [abuseIpDbApiKey]);
                useEffect(() => { sessionStorage.setItem('hybridAnalysisApiKey', hybridAnalysisApiKey); }, [hybridAnalysisApiKey]);
                
                // Persist non-sensitive settings in localStorage
                useEffect(() => { localStorage.setItem('productName', productName); }, [productName]);
                useEffect(() => { localStorage.setItem('urls', JSON.stringify(urls)); }, [urls]);
                useEffect(() => { localStorage.setItem('iocs', JSON.stringify(iocs)); }, [iocs]);
                useEffect(() => { localStorage.setItem('vtScanThreshold', vtScanThreshold); }, [vtScanThreshold]);
                useEffect(() => { localStorage.setItem('vtDeduplication', vtDeduplication); }, [vtDeduplication]);
                useEffect(() => { localStorage.setItem('vtInterpretation', vtInterpretation); }, [vtInterpretation]);
                useEffect(() => { localStorage.setItem('aiBehaviourScoring', aiBehaviourScoring); }, [aiBehaviourScoring]);
                useEffect(() => { localStorage.setItem('defaultAiResponseLength', defaultAiResponseLength); }, [defaultAiResponseLength]);
                useEffect(() => { localStorage.setItem('animationsEnabled', animationsEnabled); }, [animationsEnabled]);
                useEffect(() => { localStorage.setItem('cloudflareWorkerUrl', cloudflareWorkerUrl); }, [cloudflareWorkerUrl]);


                const processNextInQueue = useCallback(async () => {
                    if (scanQueue.length === 0) { setIsScanning(false); showToast('VirusTotal scan complete.'); return; }
                    const urlToScan = scanQueue[0];
                    setUrls(prev => prev.map(u => u.id === urlToScan.id ? { ...u, status: 'scanning' } : u));
                    
                    const PROXY_URL = getProxyUrl();
                    try {
                        const scanApiUrl = `${PROXY_URL}https://www.virustotal.com/api/v3/urls`;
                        const scanResponse = await fetch(scanApiUrl, { method: 'POST', headers: { 'x-apikey': virusTotalApiKey, 'Content-Type': 'application/x-www-form-urlencoded' }, body: `url=${encodeURIComponent(urlToScan.url)}` });
                        if (!scanResponse.ok) {
                           if (scanResponse.status === 401 || scanResponse.status === 403) throw new Error("VirusTotal API Key is invalid or unauthorized.");
                           throw new Error(`VT scan submission failed: ${scanResponse.statusText}`);
                        }
                        const scanResult = await scanResponse.json();
                        const analysisId = scanResult.data.id;
                        timeoutRef.current = setTimeout(async () => {
                            try {
                                const reportApiUrl = `${PROXY_URL}https://www.virustotal.com/api/v3/analyses/${analysisId}`;
                                const reportResponse = await fetch(reportApiUrl, { headers: { 'x-apikey': virusTotalApiKey } });
                                if (!reportResponse.ok) throw new Error(`VT report retrieval failed: ${reportResponse.statusText}`);
                                const reportResult = await reportResponse.json();
                                const attributes = reportResult.data.attributes;
                                const maliciousCount = attributes.stats.malicious;
                                const engineResults = attributes.results;
                                updateUrlStatus(urlToScan.id, 'scanned', { vtScore: maliciousCount, vtDetails: engineResults });
                            } catch (reportError) { console.error('VT Report Error:', reportError); updateUrlStatus(urlToScan.id, 'untagged'); } finally { setScanQueue(prev => prev.slice(1)); }
                        }, 15000);
                    } catch (submitError) {
                        console.error('VT Submit Error:', submitError);
                        const errorMsg = submitError.message.includes('Forbidden') ? `Scan failed. Activate CORS proxy or check Cloudflare Worker URL in Settings.` : submitError.message;
                        showToast(errorMsg, 'error');
                        updateUrlStatus(urlToScan.id, 'untagged');
                        setScanQueue(prev => prev.slice(1));
                    }
                }, [scanQueue, virusTotalApiKey, cloudflareWorkerUrl]);

                useEffect(() => {
                    if (isScanning && scanQueue.length > 0) {
                        const handle = setTimeout(processNextInQueue, 20000); // VT public API allows 4 requests per minute
                        return () => clearTimeout(handle);
                    } else if (isScanning && scanQueue.length === 0) {
                        setIsScanning(false);
                        showToast('VirusTotal scan queue finished.');
                    }
                }, [isScanning, scanQueue, processNextInQueue]);

                const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };
                const addUrls = (urlList, type) => { const newUrls = urlList.split('\n').map(url => url.trim()).filter(Boolean).map(url => ({ id: crypto.randomUUID(), url, type, status: 'untagged', vtScore: null, vtDetails: null })); setUrls(prev => [...prev, ...newUrls]); showToast(`${newUrls.length} URL(s) added.`); };
                const updateUrlStatus = (urlId, newStatus, extraData = {}) => { setUrls(prev => prev.map(url => url.id === urlId ? { ...url, status: newStatus, ...extraData } : url)); };
                const clearAllUrls = () => { setUrls([]); setEffectiveness(null); showToast('All URLs cleared.'); };

                const startVtScan = () => {
                    if (!virusTotalApiKey) { showToast('VirusTotal API key is missing. Please add it in Settings.', 'error'); return; }
                    const untestedUrls = urls.filter(u => u.status === 'untagged');
                    if (untestedUrls.length === 0) { showToast('No untested URLs to scan.', 'info'); return; }
                    setScanQueue(untestedUrls); setIsScanning(true); showToast(`Starting VT scan for ${untestedUrls.length} URLs...`);
                };

                const fetchBehaviourRiskScores = useCallback(async (fileAttributes, behaviourReport, source) => {
                    if (!geminiApiKey || !aiBehaviourScoring) return;
                    setIsScoringBehaviour(true);
                    
                    const allBehaviourData = behaviourReport?.data ?? [];
                    if (allBehaviourData.length === 0) {
                        setIsScoringBehaviour(false);
                        return;
                    }
                    
                    const aggressionInstruction = (source === 'email' || source === 'untrusted') 
                        ? "The sample originated from an untrusted source, so operate with a high degree of suspicion."
                        : "The sample's origin is neutral; maintain a standard, objective stance.";

                    const prompt = `
                    You are a malware analysis AI. Based on the following sandbox report, provide a threat score and a simple verdict.
                    - **File Context:** ${JSON.stringify(fileAttributes)}
                    - **Observed Behaviours:** ${JSON.stringify(allBehaviourData)}
                    - **Sample Source:** ${source} (${aggressionInstruction})

                    **Required Output:** Respond ONLY with a valid JSON object with two keys:
                    1. "score": A number from 0 (Safe) to 100 (Malicious).
                    2. "verdict": A single word: "Safe", "Suspicious", or "Malicious".
                    `;

                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const PROXY_URL = getProxyUrl();
                    const apiUrl = `${PROXY_URL}https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) {
                            const errorBody = await response.json().catch(() => ({ error: { message: `API Error (${response.status}) ${response.statusText}` }}));
                            throw new Error(errorBody.error.message);
                        }
                        const result = await response.json();
                        const text = result.candidates[0].content.parts[0].text;
                        
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (!jsonMatch) {
                            throw new Error("AI did not return valid JSON.");
                        }
                        const cleanedText = jsonMatch[0];
                        const parsedJson = JSON.parse(cleanedText);
                        setBehaviourRiskScores({
                            overallScore: parsedJson.score,
                            summary: parsedJson.verdict
                        });
                    } catch (error) {
                        console.error("Behaviour Scoring Error:", error);
                        showToast(`Failed to score behaviour with AI: ${error.message}`, 'error');
                    } finally {
                        setIsScoringBehaviour(false);
                    }
                }, [geminiApiKey, aiBehaviourScoring, cloudflareWorkerUrl]);

                const handleHashLookup = useCallback(async (hash) => {
                    if (!hash) return;
                    if (!virusTotalApiKey && !hybridAnalysisApiKey) {
                        setHashResult({ error: "Please add at least one API key (VirusTotal or Hybrid Analysis) in Settings." });
                        return;
                    }

                    // Reset state for the new analysis, but only if it's a new hash
                    if (!apiCache[hash]) {
                        setFileAiAnalysisResult("");
                        setMitreMatrixData(null);
                        setBehaviourRiskScores(null);
                    }
                    
                    setIsHashLoading(true);
                    setHashResult(null);
                    setHybridAnalysisResult(null);

                    // Check cache first
                    if (apiCache[hash]) {
                        setHashResult(apiCache[hash].vtResult);
                        setHybridAnalysisResult(apiCache[hash].haResult);
                        setIsHashLoading(false);
                        showToast("Loaded results from session cache.", "info");
                        return;
                    }
                    
                    const PROXY_URL = getProxyUrl();
                    
                    const safeFetch = (url, options) => fetch(url, options)
                        .then(res => {
                            if (res.ok) return res.json();
                            return res.json().catch(() => ({ error: { message: `HTTP ${res.status} ${res.statusText}` }}));
                        })
                        .catch(err => ({ error: { message: err.message } }));

                    const vtPromise = virusTotalApiKey ? 
                        Promise.all([
                            safeFetch(`${PROXY_URL}https://www.virustotal.com/api/v3/files/${hash}`, { headers: { 'x-apikey': virusTotalApiKey } }),
                            safeFetch(`${PROXY_URL}https://www.virustotal.com/api/v3/files/${hash}/behaviours`, { headers: { 'x-apikey': virusTotalApiKey } })
                        ]) : 
                        Promise.resolve([null, null]);

                    const isSha256 = /^[a-f0-9]{64}$/i.test(hash);
                    const haPromise = (hybridAnalysisApiKey && isSha256) ?
                        safeFetch(`${PROXY_URL}https://www.hybrid-analysis.com/api/v2/overview/${hash}`, { headers: { 'api-key': hybridAnalysisApiKey, 'accept': 'application/json' } }) :
                        Promise.resolve(isSha256 ? null : { error: { message: "Skipped: Hybrid Analysis requires a SHA256 hash." } });

                    try {
                        const [[vtFile, vtBehaviour], haOverview] = await Promise.all([vtPromise, haPromise]);
                        
                        const currentVtResult = (vtFile && !vtFile.error) ? { fileReport: vtFile, behaviourReport: (vtBehaviour && !vtBehaviour.error) ? vtBehaviour : { warning: "No behavioural report available." } } : (vtFile && vtFile.error) ? { error: `VirusTotal: ${vtFile.error.message}` } : null;
                        const currentHaResult = haOverview;

                        // Update state and cache
                        setHashResult(currentVtResult);
                        setHybridAnalysisResult(currentHaResult);
                        setApiCache(prev => ({ ...prev, [hash]: { vtResult: currentVtResult, haResult: currentHaResult } }));

                        if (currentVtResult && !currentVtResult.error) {
                            const threatScoreInfo = calculateVtThreatScore(currentVtResult.fileReport.data.attributes.last_analysis_results);
                            if (threatScoreInfo.comment.includes("Further behavioural analysis is recommended")) {
                                showToast('VT inconclusive. Triggering automatic AI analysis.', 'info');
                                fetchFileAiAnalysis(defaultAiResponseLength, currentSampleSource, currentVtResult);
                            }
                        }
                    } catch (error) {
                        console.error("API Lookup Error:", error);
                        setHashResult({ error: `Lookup failed: ${error.message}` });
                    } finally {
                        setIsHashLoading(false);
                    }
                }, [apiCache, virusTotalApiKey, hybridAnalysisApiKey, defaultAiResponseLength, currentSampleSource, cloudflareWorkerUrl]);
                
                const requestLookupWithSource = (hash) => {
                    setPendingHash(hash);
                    setIsSourcePromptOpen(true);
                };

                const startLookupWithSource = (source) => {
                    setCurrentSampleSource(source);
                    setIsSourcePromptOpen(false);
                    if (pendingHash) {
                        handleHashLookup(pendingHash);
                    }
                    setPendingHash(null);
                };
                
                const stats = useMemo(() => {
                    const blocked = urls.filter(u => u.status === 'blocked').length;
                    const missed = urls.filter(u => u.status === 'missed').length;
                    return { total: urls.length, tested: blocked + missed, blocked: blocked, missed: missed, dead: urls.filter(u => u.status === 'dead').length, untagged: urls.filter(u => u.status === 'untagged').length, scanning: urls.filter(u => u.status === 'scanning').length, scanned: urls.filter(u => u.status === 'scanned').length, };
                }, [urls]);

                const fetchUrlAiAnalysis = async (currentEffectiveness) => {
                    if (!geminiApiKey) { setAnalysisResult("Gemini API key is missing. Please add it in Settings to get AI analysis."); setIsAiLoading(false); return; }
                    const prompt = `You are a pragmatic and experienced cybersecurity analyst providing commentary for a security dashboard. Your analysis must reflect the real-world understanding that no security system achieves a 100% block rate. Frame the commentary positively, focusing on the product's strengths based on the data. Treat any missed URLs not as failures, but as actionable data points for refinement. Analyze the following web filter test results for "${productName}":\n- URLs Tested: ${stats.tested}\n- URLs Blocked: ${stats.blocked}\n- URLs Missed: ${stats.missed}\n- Effectiveness Score: ${currentEffectiveness.toFixed(1)}%\n\nBe concise and professional in your summary.`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const apiUrl = `${getProxyUrl()}https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error (${response.status}): ${errorData.error.message}`); }
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0) { const text = result.candidates[0].content.parts[0].text; setAnalysisResult(text); } else { throw new Error("Invalid response structure from API."); }
                    } catch (error) { console.error("Gemini API Error:", error); setAnalysisResult(`An error occurred: ${error.message}. Please check the console or your API key.`); } finally { setIsAiLoading(false); }
                };

                const fetchFileAiAnalysis = async (responseLength, source, currentHashResult = hashResult) => {
                    if (!geminiApiKey) { setFileAiAnalysisResult("Gemini API key is missing. Please add it in Settings."); setIsFileAiLoading(false); return; }
                    if (!currentHashResult || !currentHashResult.fileReport) { setFileAiAnalysisResult("No file data to analyze."); setIsFileAiLoading(false); return; }
                    
                    setIsFileAiLoading(true);
                    setFileAiAnalysisResult("");

                    const fileReportStr = JSON.stringify(currentHashResult.fileReport);
                    const behaviourSummary = JSON.stringify(currentHashResult.behaviourReport);

                    let prompt = "";
                    const context = `
                    **Input Data:**
                    - **Sample Source:** ${source}
                    - **File Report:** ${fileReportStr}
                    - **Behavioral Report:** ${behaviourSummary}
                    `;

                    switch(responseLength) {
                        case 'short':
                            prompt = `You are an AI security assistant providing an urgent summary for a non-technical user. Your tone must be simple, reassuring, and direct. Avoid all technical jargon.
                            1.  **Is it a virus?** Start with a clear "Yes, this file is a virus and is dangerous." or "No, this file seems to be safe."
                            2.  **What should I do right now?** Provide a very simple, numbered list of 2-3 immediate actions.
                            ${context}`;
                            break;
                        case 'medium':
                            prompt = `You are a cybersecurity analyst providing a summary for a general audience. Your tone is professional and informative.
                            1.  **Threat Assessment:** Start with a one-sentence summary stating the threat classification and the overall risk level.
                            2.  **Key Indicators:** List the top 3-4 most significant Indicators of Compromise (IOCs) in a bulleted list.
                            3.  **Malware's Goal:** Conclude with a short paragraph explaining the malware's likely objective.
                            ${context}`;
                            break;
                        default: // expert
                            prompt = `You are a world-class professional malware analyst providing a threat intelligence report. Your tone is technical, precise, and data-driven.
                            ${context}
                            
                            **Required Output Format (Use these exact titles as plain text headers, not markdown):**
                            **Executive Summary**
                            A brief, high-level overview of the threat.
                            
                            **Threat Actor & Campaign**
                            Attribute the malware to a known threat actor or group if possible, citing specific TTPs from the reports as evidence. If direct attribution is not possible, create a plausible profile of the likely actor (e.g., financially motivated cybercriminal, state-sponsored espionage group). Elaborate on the potential campaign this sample could be part of, its likely infection vector, and its operational goals. Describe the motives in detail (e.g., financial gain via ransomware, data theft for corporate espionage, initial access brokerage, intelligence gathering).
                            
                            **Deep Technical Analysis**
                            A detailed breakdown of the malware's actions (File System, Registry, Network, Process & Evasion). Be as detailed as possible.
                            
                            **Recommendations & Countermeasures**
                            A list of actionable steps for a SOC (Containment, Eradication, Hardening, Hunting). Make sure you got both business and home users covered.`;
                            break;
                    }

                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const apiUrl = `${getProxyUrl()}https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error (${response.status}): ${errorData.error.message}`); }
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0) { 
                            let text = result.candidates[0].content.parts[0].text; 
                            // Bolding the headers for professional structure
                            text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-[--text-main]">$1</strong>');
                            setFileAiAnalysisResult(text);
                        } else { throw new Error("Invalid response structure from API."); }
                    } catch (error) { console.error("Gemini API Error:", error); setFileAiAnalysisResult(`An error occurred: ${error.message}. Please check your API key.`); } finally { setIsFileAiLoading(false); }
                };

                const fetchMitreMatrixData = async () => {
                    if (!geminiApiKey) { setMitreMatrixData({ error: "Gemini API key is missing." }); setIsMitreLoading(false); return; }
                    if (!hashResult || !hashResult.behaviourReport) { setMitreMatrixData({ error: "No behavioral data to analyze." }); setIsMitreLoading(false); return; }

                    setIsMitreLoading(true);
                    setMitreMatrixData(null);
                    
                    const behaviourSummary = JSON.stringify(hashResult.behaviourReport);
                    const fileAttributes = hashResult?.fileReport?.data?.attributes;
                    
                    const prompt = `You are an elite cybersecurity threat intelligence analyst. Your task is to analyze the provided sandbox behavioral report and file context, then generate a comprehensive MITRE ATT&CK analysis.
                    
                    **Context:**
                    - **File Names:** ${JSON.stringify(fileAttributes?.names)}
                    - **File Type:** ${fileAttributes?.type_description}
                    - **Suggested Threat Label:** ${fileAttributes?.popular_threat_classification?.suggested_threat_label || 'N/A'}

                    **Instructions:**
                    1.  **Analyze Behaviors:** Scrutinize the provided behavioral data. For example, injecting into 'lsass.exe' or accessing 'Login Data' files maps to Credential Access. PowerShell execution maps to Execution. Creating a Run key maps to Persistence.
                    2.  **Map to ATT&CK:** Map observed actions to specific MITRE ATT&CK techniques. Provide a concise justification for each mapping, directly referencing the behavior.
                    3.  **Executive Summary:** Write a brief, high-level summary of the malware's primary objective and kill chain.
                    4.  **Overall Threat Score:** Provide an overall behavioral threat score from 0 (benign) to 100 (highly malicious) based on the severity and number of tactics observed.
                    5.  **JSON Output:** Format your entire response as a single, valid JSON object. Do not include any text or markdown formatting outside of the JSON structure.

                    **Required JSON Structure:**
                    {
                      "executiveSummary": "A brief, high-level summary...",
                      "overallThreatScore": <A number between 0 and 100>,
                      "matrix": {
                        "Reconnaissance": [], "Resource Development": [], "Initial Access": [], "Execution": [], "Persistence": [], "Privilege Escalation": [], "Defense Evasion": [], "Credential Access": [], "Discovery": [], "Lateral Movement": [], "Collection": [], "Command and Control": [], "Exfiltration": [], "Impact": []
                      }
                    }

                    **Full Behavioral Report to Analyze:**
                    ${behaviourSummary}
                    `;

                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const apiUrl = `${getProxyUrl()}https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error (${response.status}): ${errorData.error.message}`); }
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0) { 
                            const text = result.candidates[0].content.parts[0].text;
                            const cleanedText = text.replace(/```json|```/g, '').trim();
                            const parsedJson = JSON.parse(cleanedText);
                            setMitreMatrixData(parsedJson);
                        } else { 
                            throw new Error("Invalid response structure from API.");
                        }
                    } catch (error) { 
                        console.error("Gemini MITRE Error:", error); 
                        setMitreMatrixData({ error: `Failed to generate mapping: ${error.message}` });
                    } finally { 
                        setIsMitreLoading(false); 
                    }
                };

                const handleCalculateAndAnalyze = () => {
                    const testedUrls = urls.filter(u => u.status === 'blocked' || u.status === 'missed');
                    let score = 0;
                    if (testedUrls.length > 0) { const blockedCount = testedUrls.filter(u => u.status === 'blocked').length; score = (blockedCount / testedUrls.length) * 100; }
                    setEffectiveness(score); setIsAnalysisOpen(true); setIsAiLoading(true); setAnalysisResult(""); fetchUrlAiAnalysis(score);
                };

                const filteredUrls = useMemo(() => {
                    if (activeFilter === 'all') return urls;
                    return urls.filter(url => url.status === activeFilter);
                }, [urls, activeFilter]);
                
                const addIoc = (ioc) => {
                    // Prevent duplicates
                    if (iocs.some(existingIoc => existingIoc.value === ioc.value && existingIoc.type === ioc.type)) {
                        showToast('IoC already exists in the manager.', 'info');
                        return;
                    }
                    setIocs(prev => [...prev, { ...ioc, id: crypto.randomUUID(), added: new Date().toISOString() }]);
                    showToast('IoC added to manager.');
                };

                return (
                    <div className="text-[--text-main] p-4 sm:p-6 lg:p-8 relative min-h-screen">
                        <Menu 
                            isOpen={isMenuOpen} 
                            onClose={() => setIsMenuOpen(false)} 
                            onNavigate={(view) => { setActiveView(view); setIsMenuOpen(false); }} 
                            onOpenSettings={() => { setIsSettingsOpen(true); setIsMenuOpen(false); }}
                            onOpenCady={() => { setIsCadyOpen(true); setIsMenuOpen(false); }}
                            activeView={activeView} 
                            theme={theme} 
                            setTheme={setTheme} 
                        />
                        
                        <main className={`relative z-10 transition-all duration-300 ${isModalOpen || isMenuOpen ? 'blur-xl pointer-events-none' : ''}`}>
                            <header className="flex justify-between items-center mb-8">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setIsMenuOpen(true)} className="p-2 rounded-full bg-[--bg-interactive] hover:bg-opacity-20 transition-colors" aria-label="Open Menu">
                                        <Icon path={ICONS.Menu} className="w-6 h-6 text-[--text-main]" />
                                    </button>
                                    <div className="flex items-center gap-3">
                                        <Icon path={ICONS.Shield} className="w-8 h-8 text-[--accent-primary]" />
                                        <h1 className="text-2xl md:text-3xl font-bold text-[--text-main]">{productName}</h1>
                                    </div>
                                </div>
                                {activeView === 'web' && (
                                    <button onClick={startVtScan} disabled={isScanning} className="flex items-center justify-center gap-2 px-4 py-2 bg-[--accent-positive] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 h-full text-base shadow-lg shadow-green-500/20 hover:shadow-green-500/40 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:scale-100 disabled:shadow-none">
                                        {isScanning ? <Icon path={ICONS.Loader} className="w-5 h-5" spin={true} /> : <Icon path={ICONS.Search} className="w-5 h-5" />}
                                        Scan URLs
                                    </button>
                                )}
                            </header>

                            {activeView === 'web' && (
                                <Fragment>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                        <StatCard label="Total URLs" value={stats.total} />
                                        <StatCard label="Tested" value={`${stats.tested} / ${stats.total}`} />
                                        <StatCard label="Effectiveness" value={effectiveness !== null ? `${effectiveness.toFixed(1)}%` : 'N/A'} isHighlighted={effectiveness !== null} />
                                        <button onClick={handleCalculateAndAnalyze} disabled={isScanning} className="flex items-center justify-center gap-3 px-6 py-2 bg-[--accent-primary] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 h-full text-lg shadow-lg shadow-cyan-500/20 hover:shadow-cyan-400/40 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:scale-100 disabled:shadow-none">
                                            <Icon path={ICONS.BrainCircuit} className="w-6 h-6" /> Calculate & Analyze
                                        </button>
                                    </div>
                                    <FilterControls activeFilter={activeFilter} setActiveFilter={setActiveFilter} stats={stats} />
                                    <DashboardGrid urls={filteredUrls} onUrlSelect={setSelectedUrl} onOpenSettings={() => setIsSettingsOpen(true)} />
                                </Fragment>
                            )}

                            {activeView === 'file' && (
                                <FileTestView 
                                    onLookupRequest={requestLookupWithSource} 
                                    isLoading={isHashLoading} 
                                    vtResult={hashResult} 
                                    haResult={hybridAnalysisResult} 
                                    setHashResult={setHashResult} 
                                    onCardClick={() => setIsFileAnalysisModalOpen(true)} 
                                    showToast={showToast}
                                    virusTotalApiKey={virusTotalApiKey}
                                    hybridAnalysisApiKey={hybridAnalysisApiKey}
                                    getProxyUrl={getProxyUrl}
                                />
                            )}

                            {activeView === 'ioc' && (
                                <IoCManagerView 
                                    iocs={iocs} 
                                    setIocs={setIocs} 
                                    showToast={showToast} 
                                    virusTotalApiKey={virusTotalApiKey}
                                    abuseIpDbApiKey={abuseIpDbApiKey}
                                    getProxyUrl={getProxyUrl}
                                />
                            )}
                        </main>

                        {isSettingsOpen && <SettingsPanel onClose={() => setIsSettingsOpen(false)} productName={productName} setProductName={setProductName} onAddUrls={addUrls} onClearAll={clearAllUrls} geminiApiKey={geminiApiKey} setGeminiApiKey={setGeminiApiKey} virusTotalApiKey={virusTotalApiKey} setVirusTotalApiKey={setVirusTotalApiKey} abuseIpDbApiKey={abuseIpDbApiKey} setAbuseIpDbApiKey={setAbuseIpDbApiKey} hybridAnalysisApiKey={hybridAnalysisApiKey} setHybridAnalysisApiKey={setHybridAnalysisApiKey} cloudflareWorkerUrl={cloudflareWorkerUrl} setCloudflareWorkerUrl={setCloudflareWorkerUrl} vtScanThreshold={vtScanThreshold} setVtScanThreshold={setVtScanThreshold} vtDeduplication={vtDeduplication} setVtDeduplication={setVtDeduplication} vtInterpretation={vtInterpretation} setVtInterpretation={setVtInterpretation} aiBehaviourScoring={aiBehaviourScoring} setAiBehaviourScoring={setAiBehaviourScoring} defaultAiResponseLength={defaultAiResponseLength} setDefaultAiResponseLength={setDefaultAiResponseLength} animationsEnabled={animationsEnabled} setAnimationsEnabled={setAnimationsEnabled} showToast={showToast} />}
                        {selectedUrl && <TestUrlModal url={selectedUrl} onClose={() => setSelectedUrl(null)} onUpdateStatus={updateUrlStatus} />}
                        {isAnalysisOpen && <AnalysisModal onClose={() => setIsAnalysisOpen(false)} isLoading={isAiLoading} stats={stats} effectiveness={effectiveness} analysisResult={analysisResult} />}
                        {isSourcePromptOpen && <SourcePromptModal isOpen={isSourcePromptOpen} onSubmit={startLookupWithSource} />}
                        {isFileAnalysisModalOpen && (hashResult || hybridAnalysisResult) && <FileAnalysisModal onClose={() => setIsFileAnalysisModalOpen(false)} vtResult={hashResult} haResult={hybridAnalysisResult} onAiAnalyze={fetchFileAiAnalysis} aiResult={fileAiAnalysisResult} isAiLoading={isFileAiLoading} onMitreAnalyze={fetchMitreMatrixData} mitreResult={mitreMatrixData} abuseIpDbApiKey={abuseIpDbApiKey} virusTotalApiKey={virusTotalApiKey} vtDeduplication={vtDeduplication} vtInterpretation={vtInterpretation} addIoc={addIoc} behaviourRiskScores={behaviourRiskScores} isScoringBehaviour={isScoringBehaviour} fetchBehaviourRiskScores={fetchBehaviourRiskScores} sampleSource={currentSampleSource} getProxyUrl={getProxyUrl} />}
                        {isCadyOpen && <CadyModal onClose={() => setIsCadyOpen(false)} geminiApiKey={geminiApiKey} vtResult={hashResult} haResult={hybridAnalysisResult} getProxyUrl={getProxyUrl}/>}
                        {toast && <Toast message={toast.message} type={toast.type} />}
                    </div>
                );
            }

            // --- Reusable Components ---
            
            const CopyButton = React.memo(({ textToCopy }) => {
                const [copied, setCopied] = useState(false);
                const handleCopy = (e) => {
                    e.stopPropagation(); // Prevent modal click-throughs
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        setCopied(true);
                        setTimeout(() => setCopied(false), 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                    document.body.removeChild(textArea);
                };
                return (
                    <button onClick={handleCopy} className="p-1 text-[--text-dim] hover:text-[--text-main] transition-colors">
                        <Icon path={copied ? ICONS.Check : ICONS.Copy} className={`w-4 h-4 ${copied ? 'text-[--accent-positive]' : ''}`} />
                    </button>
                );
            });

            const ReputationChecker = React.memo(({ reputation, onCheck }) => {
                const renderTooltipContent = () => {
                    if (reputation?.isLoading) return <div className="flex items-center gap-2"><Icon path={ICONS.Loader} className="w-4 h-4 animate-spin" /> Checking...</div>;
                    if (reputation?.error) return <p className="text-[--accent-negative]">{reputation.error}</p>;
                    if (!reputation || !reputation.data) return <p>Check Reputation</p>;

                    if (reputation.source === 'abuseipdb') {
                        const score = reputation.data.abuseConfidenceScore;
                        const scoreColor = score > 75 ? 'text-red-500' : score > 25 ? 'text-yellow-500' : 'text-green-500';
                        return (
                            <div>
                                <p className="font-bold">AbuseIPDB Score:</p>
                                <p className={`text-lg font-bold ${scoreColor}`}>{score}% Confidence</p>
                                <p>{reputation.data.totalReports} reports</p>
                                <p>Domain: {reputation.data.domain}</p>
                            </div>
                        );
                    }

                    if (reputation.source === 'virustotal') {
                        const stats = reputation.data.last_analysis_stats;
                        const maliciousCount = stats.malicious;
                        const total = maliciousCount + stats.suspicious + stats.harmless + stats.undetected;
                        return (
                            <div>
                                <p className="font-bold">VirusTotal Score:</p>
                                <p className={`text-lg font-bold ${maliciousCount > 0 ? 'text-red-500' : 'text-green-500'}`}>
                                    {maliciousCount} / {total} Malicious
                                </p>
                                <p>Reputation: {reputation.data.reputation}</p>
                            </div>
                        );
                    }
                    return null;
                };

                return (
                    <div className="relative reputation-checker">
                        <button onClick={onCheck} disabled={reputation?.isLoading} className="p-1 text-[--text-dim] hover:text-[--text-main] disabled:cursor-not-allowed">
                           {reputation?.isLoading ? <Icon path={ICONS.Loader} className="w-4 h-4 animate-spin" /> : <Icon path={ICONS.Shield} className="w-4 h-4" />}
                        </button>
                        <div className="reputation-tooltip absolute bottom-full mb-2 right-0 w-48 bg-[--bg-secondary] border border-[--border-color] rounded-lg shadow-lg p-2 text-xs z-20">
                            {renderTooltipContent()}
                        </div>
                    </div>
                );
            });
            
            const DigitalClock = React.memo(() => {
                const [time, setTime] = useState(new Date());
                useEffect(() => {
                    const timerId = setInterval(() => setTime(new Date()), 1000);
                    return () => clearInterval(timerId);
                }, []);
                const dateString = time.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const timeString = time.toLocaleTimeString();
                return (
                    <div className="bg-black/50 p-3 rounded-md border border-[--border-color] text-center">
                        <p className="font-digital text-2xl text-[--text-accent]">{timeString}</p>
                        <p className="text-xs text-[--text-dim] mt-1">{dateString}</p>
                    </div>
                );
            });

            function Menu({ isOpen, onClose, onNavigate, onOpenSettings, onOpenCady, activeView, theme, setTheme }) {
                const [animationClass, setAnimationClass] = useState('');
                const themes = [
                    { id: 'slate', name: 'Slate' },
                    { id: 'light', name: 'Light' },
                    { id: 'cyberpunk', name: 'Cyberpunk' },
                ];
                useEffect(() => {
                    if (isOpen) {
                        setAnimationClass('menu-entering');
                    } else if (animationClass === 'menu-entering') {
                        setAnimationClass('menu-exiting');
                    }
                }, [isOpen]);
                if (!isOpen && animationClass === '') return null;
                return (
                    <Fragment>
                        <div className={`fixed inset-0 bg-slate-900/60 z-40 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}></div>
                        <div className={`fixed top-0 left-0 h-full w-72 bg-[--bg-primary] border-r border-[--border-color] z-50 p-6 flex flex-col ${animationClass}`}>
                            <h2 className="text-2xl font-bold text-[--text-main] mb-8">Analyse It!</h2>
                            <nav className="flex flex-col gap-2">
                                <button onClick={() => onNavigate('web')} className={`flex items-center gap-3 px-4 py-3 rounded-lg text-lg transition-colors ${activeView === 'web' ? 'bg-[--accent-primary]/20 text-[--text-accent]' : 'text-[--text-dim] hover:bg-[--bg-interactive] hover:text-[--text-main]'}`}>
                                    <Icon path={ICONS.Globe} className="w-6 h-6" /> Web Test
                                </button>
                                <button onClick={() => onNavigate('file')} className={`flex items-center gap-3 px-4 py-3 rounded-lg text-lg transition-colors ${activeView === 'file' ? 'bg-[--accent-primary]/20 text-[--text-accent]' : 'text-[--text-dim] hover:bg-[--bg-interactive] hover:text-[--text-main]'}`}>
                                    <Icon path={ICONS.FileCode} className="w-6 h-6" /> File Test
                                </button>
                                <button onClick={() => onNavigate('ioc')} className={`flex items-center gap-3 px-4 py-3 rounded-lg text-lg transition-colors ${activeView === 'ioc' ? 'bg-[--accent-primary]/20 text-[--text-accent]' : 'text-[--text-dim] hover:bg-[--bg-interactive] hover:text-[--text-main]'}`}>
                                    <Icon path={ICONS.List} className="w-6 h-6" /> IoC Manager
                                </button>
                                <button onClick={onOpenCady} className={`flex items-center gap-3 px-4 py-3 rounded-lg text-lg transition-colors text-[--text-dim] hover:bg-[--bg-interactive] hover:text-[--text-main]`}>
                                    <Icon path={ICONS.Bot} className="w-6 h-6" /> Talk to CADY
                                </button>
                                <button onClick={onOpenSettings} className={`flex items-center gap-3 px-4 py-3 rounded-lg text-lg transition-colors text-[--text-dim] hover:bg-[--bg-interactive] hover:text-[--text-main]`}>
                                    <Icon path={ICONS.Settings} className="w-6 h-6" /> Settings
                                </button>
                            </nav>
                            <div className="mt-auto space-y-6">
                                <DigitalClock />
                                <div>
                                    <h3 className="text-sm font-semibold text-[--text-dim] mb-2 flex items-center gap-2"><Icon path={ICONS.Palette} className="w-5 h-5" /> Themes</h3>
                                    <div className="flex flex-col gap-2">
                                        {themes.map(t => (
                                            <button key={t.id} onClick={() => setTheme(t.id)} className={`w-full text-left px-4 py-2 rounded-md text-sm font-semibold transition-all ${theme === t.id ? 'bg-[--accent-primary] text-white' : 'bg-[--bg-interactive] hover:opacity-80'}`}>
                                                {t.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Fragment>
                );
            }

            function FileTestView({ onLookupRequest, isLoading, vtResult, haResult, setHashResult, onCardClick, showToast, virusTotalApiKey, hybridAnalysisApiKey, getProxyUrl }) {
                const [hashInput, setHashInput] = useState('');
                const [isDragging, setIsDragging] = useState(false);
                const fileInputRef = useRef(null);
                const [uploadProgress, setUploadProgress] = useState({ vt: null, ha: null });
                const [isUploading, setIsUploading] = useState(false);
                
                const handleFileChange = (files) => {
                    const file = files[0];
                    if (!file) return;
                    
                    setIsUploading(true);
                    setUploadProgress({ vt: 'Hashing...', ha: 'Hashing...' });

                    const reader = new FileReader();
                    
                    reader.onerror = () => {
                        showToast("Error reading file.", 'error');
                        console.error("FileReader error:", reader.error);
                        setIsUploading(false);
                    };

                    reader.onload = async (e) => {
                        try {
                            const buffer = e.target.result;
                            if (!buffer) {
                                showToast("File is empty or could not be read.", 'error');
                                setIsUploading(false);
                                return;
                            }
                            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                            if (hashHex) {
                                setHashInput(hashHex);
                                // Now, concurrently upload to services
                                const formData = new FormData();
                                formData.append('file', file);
                                
                                const PROXY_URL = getProxyUrl();

                                // VirusTotal Upload
                                if (virusTotalApiKey) {
                                    setUploadProgress(prev => ({ ...prev, vt: 'Uploading...' }));
                                    fetch(`${PROXY_URL}https://www.virustotal.com/api/v3/files`, {
                                        method: 'POST',
                                        headers: { 'x-apikey': virusTotalApiKey },
                                        body: formData
                                    }).then(res => res.json()).then(data => {
                                        if (data.error) throw new Error(`VT: ${data.error.message}`);
                                        setUploadProgress(prev => ({ ...prev, vt: 'Success' }));
                                    }).catch(err => {
                                        console.error("VT Upload Error:", err);
                                        setUploadProgress(prev => ({ ...prev, vt: `Error: ${err.message}` }));
                                    });
                                } else {
                                    setUploadProgress(prev => ({ ...prev, vt: 'Skipped' }));
                                }

                                // Hybrid Analysis Upload
                                if (hybridAnalysisApiKey) {
                                    setUploadProgress(prev => ({ ...prev, ha: 'Uploading...' }));
                                    fetch(`${PROXY_URL}https://www.hybrid-analysis.com/api/v2/submit/file`, {
                                        method: 'POST',
                                        headers: { 'api-key': hybridAnalysisApiKey, 'accept': 'application/json' },
                                        body: formData
                                    }).then(res => res.json()).then(data => {
                                        if (data.message) throw new Error(`HA: ${data.message}`);
                                        setUploadProgress(prev => ({ ...prev, ha: 'Success' }));
                                    }).catch(err => {
                                        console.error("HA Upload Error:", err);
                                        setUploadProgress(prev => ({ ...prev, ha: `Error: ${err.message}` }));
                                    });
                                } else {
                                     setUploadProgress(prev => ({ ...prev, ha: 'Skipped' }));
                                }
                                
                                // Finally, perform the lookup
                                onLookupRequest(hashHex);

                            } else {
                                showToast("Could not generate a hash for the file.", 'error');
                            }
                        } catch (error) {
                            showToast(`Hashing failed: ${error.message}`, 'error');
                            console.error("Error during file hashing:", error);
                        } finally {
                            // Delay hiding the progress to let user see the result
                            setTimeout(() => setIsUploading(false), 5000);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };


                const handleDragEvents = (e, dragging) => {
                    e.preventDefault();
                    e.stopPropagation();
                    setIsDragging(dragging);
                };

                const handleDrop = (e) => {
                    handleDragEvents(e, false);
                    const files = e.dataTransfer.files;
                    if (files && files.length > 0) {
                        handleFileChange(files);
                    }
                };
                
                const handleSubmit = (e) => { 
                    e.preventDefault(); 
                    if (hashInput.trim()) { 
                        onLookupRequest(hashInput.trim());
                    } 
                };
                
                useEffect(() => { return () => setHashResult(null); }, []);

                return (
                    <div className="animate-fade-in h-[calc(100vh-150px)] flex flex-col">
                        <div className="mb-6">
                            <h2 className="text-3xl font-bold text-[--text-main]">File Intelligence</h2>
                            <p className="text-[--text-dim] mt-1">Analyze a file by hash or by uploading it directly for deeper analysis.</p>
                        </div>
                        
                        <div 
                            onDragEnter={(e) => handleDragEvents(e, true)}
                            onDragLeave={(e) => handleDragEvents(e, false)}
                            onDragOver={(e) => handleDragEvents(e, true)}
                            onDrop={handleDrop}
                            onClick={() => fileInputRef.current.click()}
                            className={`flex flex-col items-center justify-center p-6 mb-4 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${isDragging ? 'border-[--text-accent] bg-[--accent-primary]/10' : 'border-[--border-color] hover:border-[--text-dim]'}`}
                        >
                            <Icon path={ICONS.UploadCloud} className="w-10 h-10 text-[--text-dim] mb-2" />
                            <p className="text-[--text-main]">Drop a file here or <span className="font-semibold text-[--text-accent]">click to browse</span></p>
                            <p className="text-xs text-[--text-dim]">File is hashed locally & submitted to VT/HA for analysis.</p>
                            <input type="file" ref={fileInputRef} onChange={(e) => handleFileChange(e.target.files)} className="hidden" />
                        </div>
                        
                        {isUploading && (
                             <div className="mb-4 p-4 bg-black/20 rounded-lg grid grid-cols-2 gap-4">
                                <div className="text-center">
                                    <p className="font-semibold">VirusTotal Upload</p>
                                    <p className="text-sm text-[--text-dim]">{uploadProgress.vt}</p>
                                </div>
                                <div className="text-center">
                                    <p className="font-semibold">Hybrid Analysis Upload</p>
                                    <p className="text-sm text-[--text-dim]">{uploadProgress.ha}</p>
                                </div>
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="flex gap-2 mb-4 flex-shrink-0">
                            <input type="text" value={hashInput} onChange={e => setHashInput(e.target.value)} placeholder="Or enter SHA-256, SHA-1, or MD5 hash..." className="font-mono flex-grow bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-3 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" />
                            <button type="submit" disabled={isLoading} className="flex items-center justify-center gap-2 px-5 py-3 bg-[--accent-primary] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 shadow-lg shadow-cyan-500/20 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                                {isLoading ? <Icon path={ICONS.Loader} className="w-5 h-5" spin={true} /> : <Icon path={ICONS.Search} className="w-5 h-5" />}
                            </button>
                        </form>
                        <div className="flex-grow overflow-y-auto custom-scrollbar">
                            {isLoading && <div className="flex items-center justify-center h-full text-[--text-dim]"><Icon path={ICONS.Loader} className="w-8 h-8" spin={true} /><span className="ml-3">Querying Intelligence Sources...</span></div>}
                            {!isLoading && !vtResult && !haResult && <div className="flex items-center justify-center h-full text-[--text-dim]">Upload a file or enter a hash to begin analysis.</div>}
                            {vtResult && vtResult.error && <div className="flex items-center justify-center h-full text-[--accent-negative]">{vtResult.error}</div>}
                            {(vtResult && !vtResult.error) && <FileResultCard vtResult={vtResult} haResult={haResult} onClick={onCardClick} />}
                        </div>
                    </div>
                );
            }

            const FileResultCard = React.memo(({ vtResult, haResult, onClick }) => {
                const vtAttributes = vtResult?.fileReport?.data?.attributes;
                if (!vtAttributes) {
                    return haResult && !haResult.error ? (
                       <div onClick={onClick} className="glass-card cursor-pointer max-w-md mx-auto animate-fade-in-scale">
                            <div className="card-content flex flex-col justify-between h-full">
                                <p className="font-mono text-xs text-[--text-dim] mt-1 break-all">{haResult.sha256}</p>
                                <div className="mt-4 pt-4 border-t border-[--border-color]">
                                    <p className="text-sm text-[--text-dim]">Hybrid Analysis Verdict</p>
                                    <p className={`text-3xl font-bold capitalize ${haResult.verdict === 'malicious' ? 'text-[--accent-negative]' : haResult.verdict === 'suspicious' ? 'text-[--accent-warning]' : 'text-[--accent-positive]'}`}>{haResult.verdict}</p>
                                </div>
                            </div>
                        </div>
                    ) : null;
                }

                const maliciousCount = vtAttributes.last_analysis_stats.malicious;
                const totalEngines = Object.keys(vtAttributes.last_analysis_results).length;
                const primaryName = vtAttributes.names?.[0] || vtAttributes.md5;
                const threatLabel = vtAttributes.popular_threat_classification?.suggested_threat_label;

                const haVerdict = haResult?.verdict;

                return (
                    <div onClick={onClick} className="glass-card cursor-pointer max-w-md mx-auto animate-fade-in-scale">
                        <div className="card-content flex flex-col justify-between h-full">
                            <div>
                                <div className="flex justify-between items-start">
                                    <span className="px-2 py-1 text-xs font-medium rounded-full bg-indigo-500/20 text-indigo-300">{vtAttributes.type_description || 'File'}</span>
                                    {threatLabel && <span className="px-2 py-1 text-xs font-medium rounded-full bg-red-500/20 text-red-300">{threatLabel}</span>}
                                </div>
                                <p className="font-mono text-lg text-[--text-main] mt-3 break-all line-clamp-2" title={primaryName}>{primaryName}</p>
                                <p className="font-mono text-xs text-[--text-dim] mt-1 break-all">{vtAttributes.sha256}</p>
                            </div>
                            <div className="mt-4 pt-4 border-t border-[--border-color] grid grid-cols-2 gap-4">
                                <div>
                                    <p className="text-sm text-[--text-dim]">VirusTotal Score</p>
                                    <p className={`text-3xl font-bold ${maliciousCount > 0 ? 'text-[--accent-negative]' : 'text-[--accent-positive]'}`}>
                                        {maliciousCount} / {totalEngines}
                                    </p>
                                </div>
                                {haResult && !haResult.error && (
                                     <div>
                                        <p className="text-sm text-[--text-dim]">Hybrid Analysis</p>
                                        <p className={`text-3xl font-bold capitalize ${haVerdict === 'malicious' ? 'text-[--accent-negative]' : haVerdict === 'suspicious' ? 'text-[--accent-warning]' : 'text-[--accent-positive]'}`}>
                                            {haVerdict || 'N/A'}
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            });
            
            function OverallThreatFactorTab({ vtResult, haResult, behaviourRiskScores, sampleSource }) {
                const scores = useMemo(() => {
                    // 1. Origin Score
                    let originScore = 50;
                    if (sampleSource === 'email' || sampleSource === 'untrusted') originScore = 90;
                    else if (sampleSource === 'trusted') originScore = 20;

                    // 2. Timestamp Score
                    let timestampScore = 10;
                    const attrs = vtResult?.fileReport?.data?.attributes;
                    if (attrs) {
                        const compileTime = attrs.creation_date ? new Date(attrs.creation_date * 1000) : (attrs.pe_info?.timestamp ? new Date(attrs.pe_info.timestamp * 1000) : null);
                        const firstSeenTime = new Date(attrs.first_submission_date * 1000);
                        if (compileTime) {
                            if (compileTime > new Date()) timestampScore = 95; // Future date
                            else if (compileTime.getFullYear() < 2000) timestampScore = 95; // Ancient date
                            else if (firstSeenTime - compileTime > 1000 * 60 * 60 * 24 * 365 * 2) { // > 2 years
                                timestampScore = 75;
                            }
                        }
                    }

                    // 3. Engine Score
                    const vtScore = calculateVtThreatScore(attrs?.last_analysis_results).score || 0;
                    const haScore = haResult?.threat_score || 0;
                    let engineScore = 0;
                    if (vtScore > 0 && haScore > 0) {
                        engineScore = (vtScore * 0.7) + (haScore * 0.83);
                    } else {
                        engineScore = vtScore || haScore;
                    }

                    // 4. Behaviour Score
                    const behaviourScore = behaviourRiskScores?.overallScore || 0;

                    // Final OTS Calculation
                    const ots = (originScore * 0.25) + (timestampScore * 0.10) + (engineScore * 0.85) + (behaviourScore * 0.50);
                    
                    return {
                        origin: { score: originScore, label: "Origin Factor" },
                        timestamp: { score: timestampScore, label: "Timestamp Anomaly" },
                        engine: { score: Math.round(engineScore), label: "Engine Consensus" },
                        behaviour: { score: behaviourScore, label: "AI Behavioural Score" },
                        ots: Math.min(100, Math.round(ots)), // Cap at 100
                    };
                }, [vtResult, haResult, behaviourRiskScores, sampleSource]);

                const getOtsColor = (score) => {
                    if (score > 75) return 'text-[--accent-negative]';
                    if (score > 50) return 'text-[--accent-warning]';
                    return 'text-[--accent-positive]';
                };
                
                const AnimatedFactorCard = ({ label, score }) => {
                    const animatedScore = useAnimatedCounter(score);
                    return (
                        <div className="bg-black/20 p-4 rounded-lg text-center">
                            <h3 className="text-sm text-[--text-dim] mb-1 tracking-wider uppercase">{label}</h3>
                            <p className={`text-3xl font-bold ${getOtsColor(score)}`}>{animatedScore}</p>
                        </div>
                    );
                };
                
                const animatedOts = useAnimatedCounter(scores.ots);

                return (
                    <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-1 flex flex-col items-center justify-center bg-black/20 p-6 rounded-lg">
                                <h2 className="text-lg font-semibold text-[--text-dim] mb-2">Overall Threat Score</h2>
                                <p className={`font-digital text-8xl font-bold ${getOtsColor(scores.ots)}`}>{animatedOts}</p>
                                <p className={`text-2xl font-semibold ${getOtsColor(scores.ots)}`}>
                                    {scores.ots > 75 ? "High Risk" : scores.ots > 50 ? "Suspicious" : "Likely Safe"}
                                </p>
                            </div>
                            <div className="md:col-span-2 grid grid-cols-2 gap-4">
                                <AnimatedFactorCard label={scores.origin.label} score={scores.origin.score} />
                                <AnimatedFactorCard label={scores.timestamp.label} score={scores.timestamp.score} />
                                <AnimatedFactorCard label={scores.engine.label} score={scores.engine.score} />
                                <AnimatedFactorCard label={scores.behaviour.label} score={scores.behaviour.score} />
                            </div>
                        </div>
                    </div>
                );
            }

            function FileAnalysisModal({ onClose, vtResult, haResult, onAiAnalyze, aiResult, isAiLoading, onMitreAnalyze, mitreResult, isMitreLoading, abuseIpDbApiKey, virusTotalApiKey, vtDeduplication, vtInterpretation, addIoc, behaviourRiskScores, isScoringBehaviour, fetchBehaviourRiskScores, sampleSource, getProxyUrl }) {
                const [activeTab, setActiveTab] = useState('threat-factor');
                const [aiResponseLength, setAiResponseLength] = useState('expert');
                const fileAttrs = vtResult?.fileReport?.data?.attributes;
                const allBehaviourData = vtResult?.behaviourReport?.data || [];
                const [iocReputations, setIocReputations] = useState({});
                
                useEffect(() => {
                    // Trigger automatic scoring when the modal opens if it hasn't been done yet
                    if (vtResult?.behaviourReport && !isScoringBehaviour && !behaviourRiskScores && !vtResult.behaviourReport.warning) {
                        fetchBehaviourRiskScores(fileAttrs, vtResult.behaviourReport, sampleSource);
                    }
                }, [vtResult, fetchBehaviourRiskScores, isScoringBehaviour, behaviourRiskScores, sampleSource, fileAttrs]);

                const checkIocReputation = useCallback(async (value, type) => {
                    setIocReputations(prev => ({...prev, [value]: { isLoading: true }}));
                    const PROXY_URL = getProxyUrl();
                    let endpoint, headers, source;

                    if (type === 'ip' && abuseIpDbApiKey) {
                        endpoint = `${PROXY_URL}https://api.abuseipdb.com/api/v2/check?ipAddress=${encodeURIComponent(value)}`;
                        headers = { 'Key': abuseIpDbApiKey, 'Accept': 'application/json' };
                        source = 'abuseipdb';
                    } else if (type === 'domain' && virusTotalApiKey) {
                        endpoint = `${PROXY_URL}https://www.virustotal.com/api/v3/domains/${value}`;
                        headers = { 'x-apikey': virusTotalApiKey };
                        source = 'virustotal';
                    } else {
                        setIocReputations(prev => ({...prev, [value]: { error: "API Key Missing" }}));
                        return;
                    }

                    try {
                        const response = await fetch(endpoint, { headers });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.errors?.[0]?.detail || errorData.error?.message || `API Error (${response.status})`);
                        }
                        const result = await response.json();
                        setIocReputations(prev => ({...prev, [value]: { source, data: source === 'abuseipdb' ? result.data : result.data.attributes }}));
                    } catch (error) {
                        setIocReputations(prev => ({...prev, [value]: { error: error.message }}));
                    }
                }, [abuseIpDbApiKey, virusTotalApiKey, getProxyUrl]);


                const { processedList: detections, originalCount } = useMemo(() => {
                    if (!fileAttrs?.last_analysis_results) return { processedList: [], originalCount: 0 };
                    return processDetections(fileAttrs.last_analysis_results, vtDeduplication);
                }, [fileAttrs, vtDeduplication]);

                const threatScoreInfo = useMemo(() => {
                    if (!vtInterpretation || !fileAttrs?.last_analysis_results) return null;
                    return calculateVtThreatScore(fileAttrs.last_analysis_results);
                }, [fileAttrs, vtInterpretation]);

                const handleExportPdf = () => {
                    const doc = new jsPDF();
                    let y = 15;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 10;

                    const addText = (text, size, style, indent = 0) => {
                        if (y > pageHeight - margin) { doc.addPage(); y = margin; }
                        doc.setFontSize(size);
                        doc.setFont(undefined, style);
                        const lines = doc.splitTextToSize(String(text), 180 - indent);
                        doc.text(lines, margin + indent, y);
                        y += (lines.length * (size / 2.5));
                    };

                    const addTitle = (text) => { y += 5; addText(text, 14, 'bold'); y += 2; };
                    const addSubtitle = (text) => { y += 3; addText(text, 11, 'bold'); };
                    const addBody = (text, indent = 0) => addText(text, 10, 'normal', indent);
                    const addKeyValue = (key, value) => addBody(`${key}: ${value || 'N/A'}`);

                    // --- Header ---
                    addText(`Analyse It! - Security Analysis Report`, 18, 'bold');
                    addText(new Date().toLocaleString(), 8, 'normal');
                    y += 5;

                    // --- Summary Tab ---
                    if (fileAttrs) {
                        addTitle("File Summary & Hashes");
                        addKeyValue("Sample Source", sampleSource);
                        if (sampleSource === 'email' || sampleSource === 'untrusted') {
                            addKeyValue("Analysis Stance", "Aggressive");
                        }
                        addKeyValue("Primary Name", fileAttrs.names?.[0]);
                        addKeyValue("File Type", fileAttrs.type_description);
                        addKeyValue("File Size", `${fileAttrs.size.toLocaleString()} bytes`);
                        addKeyValue("First Seen", new Date(fileAttrs.first_submission_date * 1000).toLocaleString());
                        addKeyValue("MD5", fileAttrs.md5);
                        addKeyValue("SHA-1", fileAttrs.sha1);
                        addKeyValue("SHA-256", fileAttrs.sha256);
                    }

                    // --- Detections Tab ---
                    if (threatScoreInfo) {
                        addTitle("VirusTotal Threat Score");
                        addKeyValue("Score", `${threatScoreInfo.score}/100`);
                        addBody(threatScoreInfo.comment);
                    }
                    if (detections.length > 0) {
                        addSubtitle("Malicious Detections");
                        detections.forEach(d => addKeyValue(`- ${d.engine}`, d.result));
                    }

                    // --- Hybrid Analysis Tab ---
                    if (haResult && !haResult.error) {
                        addTitle("Hybrid Analysis Overview");
                        addKeyValue("Verdict", haResult.verdict);
                        addKeyValue("Threat Score", haResult.threat_score);
                        if(haResult.mitre_attcks && haResult.mitre_attcks.length > 0) {
                            addSubtitle("MITRE ATT&CK Techniques (HA)");
                            haResult.mitre_attcks.forEach(m => addBody(`- ${m.tactic}: ${m.technique} (${m.identifier})`));
                        }
                    }

                    // --- Behaviour Tab ---
                    if (allBehaviourData.length > 0) {
                        addTitle("Sandbox Behavioural Analysis");
                        const behaviourGroups = getBehaviourGroups(allBehaviourData);
                        Object.entries(behaviourGroups).forEach(([groupName, actions]) => {
                            if (actions.length > 0) {
                                addSubtitle(groupName.charAt(0).toUpperCase() + groupName.slice(1).replace(/([A-Z])/g, ' $1'));
                                actions.forEach(action => addBody(`- ${action.title}: ${action.content}`, 5));
                            }
                        });
                    }

                    // --- MITRE ATT&CK Tab ---
                    if (mitreResult && !mitreResult.error && mitreResult.matrix) {
                        addTitle("AI-Generated MITRE ATT&CK Analysis");
                        addKeyValue("Overall Behavioural Threat Score", mitreResult.overallThreatScore);
                        addSubtitle("Executive Summary");
                        addBody(mitreResult.executiveSummary);
                        Object.entries(mitreResult.matrix).forEach(([tactic, techniques]) => {
                            if(techniques.length > 0) {
                                addSubtitle(tactic);
                                techniques.forEach(tech => {
                                    addBody(`- ${tech.techniqueName} (${tech.technique})`, 5);
                                    addBody(tech.justification, 10);
                                });
                            }
                        });
                    }
                    
                    // --- AI Analysis Tab ---
                    if(aiResult) {
                        addTitle("AI Expert Analysis");
                        addBody(aiResult.replace(/<strong.*?>/g, '').replace(/<\/strong>/g, '')); // Remove HTML for PDF
                    }

                    doc.save(`report-${(fileAttrs || haResult).sha256.substring(0,10)}.pdf`);
                };

                const getBehaviourGroups = (behaviourData) => {
                    const aggregate = (key) => behaviourData.flatMap(report => report.attributes?.[key] ?? []);
                    return {
                        commands: aggregate('command_executions').map((c, i) => ({ id: `cmd_${i}`, title: 'Command Executed', content: c, ioc: { value: c, type: 'command' } })),
                        network: [
                            ...aggregate('dns_lookups').map((d, i) => ({ id: `dns_${i}`, title: `DNS Lookup: ${d.hostname}`, content: `Resolved IPs: ${d.resolved_ips?.join(', ') || 'N/A'}`, ioc: { value: d.hostname, type: 'domain' } })),
                            ...aggregate('ip_traffic').map((t, i) => ({ id: `ip_${i}`, title: `IP Traffic: ${t.destination_ip}`, content: `Port: ${t.destination_port}, Protocol: ${t.transport_layer_protocol}`, ioc: { value: t.destination_ip, type: 'ip' } }))
                        ],
                        filesDropped: aggregate('files_dropped').map((f, i) => ({ id: `file_drop_${i}`, title: `Path: ${f.path}`, content: `SHA256: ${f.sha256}`, ioc: { value: f.sha256, type: 'hash-sha256' } })),
                        filesOpened: aggregate('files_opened').map((f, i) => ({ id: `file_open_${i}`, title: `File Opened`, content: f, ioc: { value: f, type: 'filepath' } })),
                        filesWritten: aggregate('files_written').map((f, i) => ({ id: `file_write_${i}`, title: `File Written`, content: f, ioc: { value: f, type: 'filepath' } })),
                        filesDeleted: aggregate('files_deleted').map((f, i) => ({ id: `file_delete_${i}`, title: `File Deleted`, content: f, ioc: { value: f, type: 'filepath' } })),
                        registrySet: aggregate('registry_keys_set').map((k, i) => ({ id: `reg_set_${i}`, title: `Key: ${k.key}`, content: `Value: ${k.value}`, ioc: { value: k.key, type: 'registry' } })),
                        registryDeleted: aggregate('registry_keys_deleted').map((k, i) => ({ id: `reg_del_${i}`, title: `Key Deleted`, content: k, ioc: { value: k, type: 'registry' } })),
                    };
                };

                const renderTabContent = () => {
                    if (!vtResult && activeTab !== 'hybrid-analysis') return <div className="p-4 text-center text-[--text-dim]">No VirusTotal data available.</div>;
                    if (!haResult && activeTab === 'hybrid-analysis') return <div className="p-4 text-center text-[--text-dim]">No Hybrid Analysis data available.</div>;

                    switch (activeTab) {
                        case 'threat-factor':
                           return <OverallThreatFactorTab vtResult={vtResult} haResult={haResult} behaviourRiskScores={behaviourRiskScores} sampleSource={sampleSource} />;
                        case 'summary':
                            const iocsFromSummary = [
                                { value: fileAttrs.md5, type: 'hash-md5' },
                                { value: fileAttrs.sha1, type: 'hash-sha1' },
                                { value: fileAttrs.sha256, type: 'hash-sha256' },
                            ];
                            const isAggressive = sampleSource === 'email' || sampleSource === 'untrusted';
                            return (
                                <div className="space-y-3 text-sm">
                                    <div className="flex items-center justify-between"><strong className="text-[--text-dim] w-32 inline-block">Primary Name:</strong> <span className="font-mono flex-1">{fileAttrs.names?.[0] || 'N/A'}</span></div>
                                    <div className="flex items-center justify-between"><strong className="text-[--text-dim] w-32 inline-block">File Type:</strong> <span className="flex-1">{fileAttrs.type_description}</span></div>
                                    <div className="flex items-center justify-between"><strong className="text-[--text-dim] w-32 inline-block">File Size:</strong> <span className="flex-1">{fileAttrs.size.toLocaleString()} bytes</span></div>
                                    <div className="flex items-center justify-between"><strong className="text-[--text-dim] w-32 inline-block">First Seen:</strong> <span className="flex-1">{new Date(fileAttrs.first_submission_date * 1000).toLocaleString()}</span></div>
                                    <div className={`flex items-center justify-between p-2 rounded-lg ${isAggressive ? 'bg-red-500/10' : 'bg-green-500/10'}`}>
                                        <strong className="text-[--text-dim] w-32 inline-block">Analysis Stance:</strong> 
                                        <span className={`flex-1 font-semibold capitalize ${isAggressive ? 'text-red-400' : 'text-green-400'}`}>{isAggressive ? 'Aggressive' : 'Standard'}</span>
                                    </div>
                                    <div className="pt-2 mt-2 border-t border-[--border-color]">
                                        {iocsFromSummary.map(ioc => (
                                            <div key={ioc.type} className="flex items-center justify-between gap-2 mt-2">
                                                <strong className="text-[--text-dim] w-32 inline-block">{ioc.type.split('-')[1].toUpperCase()}:</strong>
                                                <span className="font-mono flex-1 break-all">{ioc.value}</span>
                                                <button onClick={() => addIoc({ value: ioc.value, type: ioc.type, source: fileAttrs.sha256 })} className="p-1 text-[--text-dim] hover:text-[--text-main]" title="Add to IoC Manager"><Icon path={ICONS.Plus} className="w-4 h-4" /></button>
                                                <CopyButton textToCopy={ioc.value} />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        case 'detections':
                            return (
                                <div>
                                    {threatScoreInfo && <VtInterpretationWidget info={threatScoreInfo} />}
                                    {detections.length > 0 ? (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                                            {detections.map(({ engine, result }) => (
                                                <div key={engine} className="flex justify-between items-center bg-black/20 p-2 rounded-md">
                                                    <span className="text-[--text-dim]">{engine}</span>
                                                    <span className="font-mono text-[--accent-negative] text-xs text-right">{result}</span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : <p className="text-[--text-dim]">No malicious detections.</p>}
                                    {vtDeduplication && detections.length < originalCount && (
                                        <p className="text-xs text-[--text-dim] text-center mt-4">
                                            {originalCount - detections.length} redundant detections hidden for clarity.
                                        </p>
                                    )}
                                </div>
                            );
                        case 'behaviour':
                            if (allBehaviourData.length === 0) return <p className="text-[--text-dim]">{vtResult.behaviourReport.warning || "No behaviour data available."}</p>;
                            
                            const behaviourGroups = getBehaviourGroups(allBehaviourData);
                            const isAggressiveStance = sampleSource === 'email' || sampleSource === 'untrusted';

                            return (
                                <div>
                                    {isScoringBehaviour && <div className="flex items-center justify-center text-[--text-dim] mb-4"><Icon path={ICONS.Loader} spin={true} className="w-5 h-5 mr-2" />AI is scoring behaviours...</div>}
                                    {isAggressiveStance && !isScoringBehaviour && behaviourRiskScores && (
                                        <div className="p-3 mb-4 text-sm text-orange-300 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                                            <strong>Aggressive Analysis Active:</strong> AI scoring is operating with increased suspicion due to the untrusted sample source.
                                        </div>
                                    )}
                                    {behaviourRiskScores && <AiSummaryWidget title="AI Behavioural Threat Assessment" score={behaviourRiskScores.overallScore} summary={behaviourRiskScores.summary} scoreLabel="Threat Score" />}
                                    <div className="space-y-4">
                                        {Object.entries(behaviourGroups).map(([groupName, actions]) => (
                                            actions.length > 0 && <BehaviourGroupAccordion key={groupName} title={groupName} actions={actions} addIoc={addIoc} sourceHash={fileAttrs.sha256} />
                                        ))}
                                    </div>
                                </div>
                            );
                        case 'hybrid-analysis':
                            return <HybridAnalysisReport report={haResult} abuseIpDbApiKey={abuseIpDbApiKey} virusTotalApiKey={virusTotalApiKey} addIoc={addIoc} sourceHash={haResult.sha256} iocReputations={iocReputations} onCheckReputation={checkIocReputation} />;
                        case 'ai':
                             return (
                                <div>
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="flex items-center gap-1 bg-black/20 p-1 rounded-lg">
                                            <button onClick={() => setAiResponseLength('short')} className={`px-3 py-1 text-sm rounded-md ${aiResponseLength === 'short' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Concise</button>
                                            <button onClick={() => setAiResponseLength('medium')} className={`px-3 py-1 text-sm rounded-md ${aiResponseLength === 'medium' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Balanced</button>
                                            <button onClick={() => setAiResponseLength('expert')} className={`px-3 py-1 text-sm rounded-md ${aiResponseLength === 'expert' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Expert</button>
                                        </div>
                                        <button onClick={() => onAiAnalyze(aiResponseLength, sampleSource)} disabled={isAiLoading} className="flex items-center justify-center gap-3 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-500 transition-all duration-300 shadow-lg shadow-purple-500/20 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                                            {isAiLoading ? <Icon path={ICONS.Loader} className="w-5 h-5" spin={true} /> : <Icon path={ICONS.BrainCircuit} className="w-5 h-5" />}
                                            {aiResult ? 'Re-Analyze' : 'Analyze'}
                                        </button>
                                    </div>
                                    {isAiLoading && <LoadingTree />}
                                    {aiResult && <div className="text-[--text-dim] whitespace-pre-wrap bg-black/20 p-4 rounded-lg" dangerouslySetInnerHTML={{ __html: aiResult.replace(/\n\n/g, '<br /><br />').replace(/\n/g, '<br />') }}></div>}
                                </div>
                            );
                        case 'att&ck':
                            return (
                                <div>
                                    <button onClick={onMitreAnalyze} disabled={isMitreLoading} className="w-full flex items-center justify-center gap-3 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500 transition-all duration-300 shadow-lg shadow-blue-500/20 hover:shadow-blue-400/40 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed mb-4">
                                        {isMitreLoading ? <Icon path={ICONS.Loader} className="w-6 h-6" spin={true} /> : <Icon path={ICONS.BrainCircuit} className="w-6 h-6" />}
                                        {mitreResult ? 'Re-Generate Matrix' : 'Generate ATT&CK Matrix'}
                                    </button>
                                    {isMitreLoading && <LoadingTree />}
                                    {mitreResult && mitreResult.error && <p className="text-[--accent-negative]">{mitreResult.error}</p>}
                                    {mitreResult && !mitreResult.error && <MitreGridMatrix matrix={mitreResult.matrix} />}
                                </div>
                            );
                        default: return null;
                    }
                };
                
                const availableTabs = [];
                if(vtResult && !vtResult.error) availableTabs.push('threat-factor', 'summary', 'detections', 'behaviour');
                if (haResult && !haResult.error) availableTabs.push('hybrid-analysis');
                if (vtResult && !vtResult.error) availableTabs.push('ai', 'att&ck');


                return (
                    <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                        <div className="ios-modal-glass w-full max-w-7xl rounded-3xl animate-fade-in-scale" onClick={e => e.stopPropagation()}>
                            <div className="p-6 max-h-[90vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4 flex-shrink-0">
                                    <h2 className="text-xl font-bold text-[--text-main]">File Analysis Report</h2>
                                    <div className="flex items-center gap-2">
                                        <button onClick={handleExportPdf} className="p-2 rounded-full bg-[--bg-interactive] hover:opacity-80" title="Export to PDF"><Icon path={ICONS.Download} className="w-5 h-5"/></button>
                                        <button onClick={onClose} className="p-1 rounded-full bg-[--bg-interactive] hover:opacity-80"><Icon path={ICONS.X} className="w-5 h-5"/></button>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 border-b border-[--border-color] mb-4 flex-shrink-0">
                                    {availableTabs.map(tab => (
                                        <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors ${activeTab === tab ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>
                                            {tab.replace('-', ' ')}
                                        </button>
                                    ))}
                                </div>
                                <div className="flex-grow overflow-y-auto custom-scrollbar pr-2">
                                    {renderTabContent()}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            function HybridAnalysisReport({ report, abuseIpDbApiKey, virusTotalApiKey, addIoc, sourceHash, iocReputations, onCheckReputation }) {
                if (report.error) {
                    return <div className="p-4 text-center text-[--text-dim]">{report.error.message}</div>;
                }

                const { verdict, threat_score, mitre_attcks, hosts, domains } = report;
                const scoreColor = threat_score > 75 ? 'bg-red-500' : threat_score > 50 ? 'bg-orange-500' : 'bg-gray-500';
                const verdictColor = verdict === 'malicious' ? 'text-[--accent-negative]' : verdict === 'suspicious' ? 'text-[--accent-warning]' : 'text-[--accent-positive]';
                
                const hostIocs = (hosts || []).map(h => ({ value: h, type: 'ip' }));
                const domainIocs = (domains || []).map(d => ({ value: d, type: 'domain' }));

                return (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-black/20 p-4 rounded-lg text-center">
                                <h3 className="text-sm text-[--text-dim] mb-1 tracking-wider uppercase">Verdict</h3>
                                <p className={`text-3xl font-bold capitalize ${verdictColor}`}>{verdict}</p>
                            </div>
                            <div className="bg-black/20 p-4 rounded-lg">
                                <h3 className="text-sm text-[--text-dim] mb-2 tracking-wider uppercase text-center">Threat Score</h3>
                                <div className="w-full bg-gray-700 rounded-full h-4">
                                    <div className={`${scoreColor} h-4 rounded-full`} style={{ width: `${threat_score}%` }}></div>
                                </div>
                                <p className="text-center text-lg font-bold mt-1">{threat_score} / 100</p>
                            </div>
                        </div>

                        {mitre_attcks && mitre_attcks.length > 0 && (
                             <div>
                                <h3 className="text-lg font-semibold text-[--text-accent] mb-2">MITRE ATT&CK Tactics</h3>
                                <div className="bg-black/20 rounded-lg overflow-hidden">
                                    <table className="w-full text-sm">
                                        <thead className="bg-black/30">
                                            <tr>
                                                <th className="p-3 text-left w-1/3 text-[--text-dim]">Tactic</th>
                                                <th className="p-3 text-left w-2/3 text-[--text-dim]">Technique</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {mitre_attcks.map((item, index) => (
                                                <tr key={index} className="border-t border-[--border-color]">
                                                    <td className="p-3 align-top">{item.tactic}</td>
                                                    <td className="p-3 align-top font-mono text-xs">{item.technique} ({item.identifier})</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        {hostIocs.length > 0 && <IocTable title="Contacted Hosts" iocs={hostIocs} addIoc={addIoc} sourceHash={sourceHash} iocReputations={iocReputations} onCheckReputation={onCheckReputation} />}
                        {domainIocs.length > 0 && <IocTable title="Contacted Domains" iocs={domainIocs} addIoc={addIoc} sourceHash={sourceHash} iocReputations={iocReputations} onCheckReputation={onCheckReputation} />}
                    </div>
                );
            }

            const Toast = ({ message, type }) => {
                const colors = {
                    success: 'bg-[--accent-positive]',
                    error: 'bg-[--accent-negative]',
                    info: 'bg-[--accent-primary]',
                };
                const icon = {
                    success: ICONS.ShieldCheck,
                    error: ICONS.ShieldOff,
                    info: ICONS.Info,
                }
                return ( <div className={`fixed bottom-8 left-1/2 -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-2xl z-50`} style={{animation: 'slideInUp 0.5s ease-out forwards, fadeOut 0.5s ease-in 2.5s forwards'}}> <div className="flex items-center gap-2"> <Icon path={icon[type]} className="w-5 h-5" /> <span>{message}</span> </div> </div> );
            }
            const FilterControls = ({ activeFilter, setActiveFilter, stats }) => { const filters = [ { id: 'all', label: 'All' }, { id: 'untagged', label: 'Untested' }, { id: 'scanning', label: 'Scanning' }, { id: 'scanned', label: 'Scanned' }, { id: 'blocked', label: 'Blocked' }, { id: 'missed', label: 'Missed' }, { id: 'dead', label: 'Dead' } ]; return ( <div className="mb-4 flex items-center gap-2 overflow-x-auto pb-2"> {filters.map(filter => ( <button key={filter.id} onClick={() => setActiveFilter(filter.id)} className={`px-4 py-2 text-sm font-semibold rounded-md whitespace-nowrap transition-colors ${activeFilter === filter.id ? 'bg-[--accent-primary] text-white' : 'bg-[--bg-secondary] hover:opacity-80 text-[--text-dim]'}`}> {filter.label} <span className="ml-1.5 text-xs opacity-70">{stats[filter.id] || 0}</span> </button> ))} </div> ); };
            const StatCard = React.memo(({ label, value, isHighlighted }) => ( <div className="glass-card p-4 flex flex-col justify-center items-center !transform-none !shadow-none hover:!shadow-none"> <h3 className="text-sm text-[--text-dim] mb-1 tracking-wider uppercase">{label}</h3> <p className={`text-3xl font-bold ${isHighlighted ? 'text-[--text-accent]' : 'text-[--text-main]'}`}>{value}</p> </div> ));
            
            const DashboardGrid = ({ urls, onUrlSelect, onOpenSettings }) => {
                const panelRef = useRef(null);
                useEffect(() => {
                    const panel = panelRef.current; if (!panel) return;
                    const handleMouseMove = (e) => { const rect = panel.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; panel.style.setProperty('--mouse-x', `${x}px`); panel.style.setProperty('--mouse-y', `${y}px`); };
                    panel.addEventListener('mousemove', handleMouseMove);
                    return () => { panel.removeEventListener('mousemove', handleMouseMove); };
                }, []);
                return (<div ref={panelRef} className="glowing-panel h-[calc(100vh-320px)] overflow-y-auto custom-scrollbar"><div className="panel-content-wrapper">{urls.length === 0 ? (<div className="flex flex-col items-center justify-center h-full text-[--text-dim] p-4"><Icon path={ICONS.Shield} className="w-16 h-16 opacity-50 mb-4"/><h3 className="text-xl font-bold text-[--text-main] mb-2">Your Dashboard is Ready</h3><p className="text-center max-w-sm mb-6">Start by adding a list of potentially malicious URLs to test your product's effectiveness.</p><button onClick={onOpenSettings} className="flex items-center justify-center gap-2 px-6 py-3 bg-[--accent-primary] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 shadow-lg shadow-cyan-500/20 transform hover:scale-105"><Icon path={ICONS.Plus} className="w-5 h-5"/> Add First URLs</button></div>) : (<div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 p-4">{urls.map(item => (<UrlCard key={item.id} url={item} onSelect={onUrlSelect} />))}</div>)}</div></div>);
            };

            const UrlCard = React.memo(({ url, onSelect }) => ( <div onClick={() => onSelect(url)} className="glass-card cursor-pointer h-40"> <div className="card-content flex flex-col justify-between h-full"> <div> <span className={`px-2 py-1 text-xs font-medium rounded-full ${url.type === 'phishing' ? 'bg-yellow-400/20 text-yellow-300' : 'bg-red-500/20 text-red-400'}`}>{url.type}</span> <p className="font-mono text-sm text-[--text-dim] mt-3 break-all line-clamp-2" title={url.url}>{url.url}</p> </div> <StatusBadge status={url.status} vtScore={url.vtScore} /> </div> </div> ));
            const StatusBadge = React.memo(({ status, vtScore }) => { const statusMap = { untagged: { text: 'Untested', icon: <Icon path={ICONS.X} className="w-3 h-3"/>, color: 'text-[--text-dim]' }, scanning: { text: 'Scanning...', icon: <Icon path={ICONS.Loader} className="w-4 h-4" spin={true} />, color: 'text-blue-400' }, scanned: { text: 'Scanned', icon: <Icon path={ICONS.Info} className="w-4 h-4"/>, color: 'text-sky-400' }, blocked: { text: 'Blocked', icon: <Icon path={ICONS.ShieldCheck} className="w-4 h-4"/>, color: 'text-[--accent-positive]' }, missed: { text: 'Missed', icon: <Icon path={ICONS.ShieldOff} className="w-4 h-4"/>, color: 'text-[--accent-warning]' }, dead: { text: 'Dead Link', icon: <Icon path={ICONS.Skull} className="w-4 h-4"/>, color: 'text-purple-400' }, }; const current = statusMap[status] || statusMap.untagged; return <span className={`flex items-center gap-2 text-sm font-medium ${current.color}`}>{current.icon} {current.text} {vtScore !== null && `(${vtScore})`}</span>; });
            
            function TestUrlModal({ url, onClose, onUpdateStatus }) { const openUrl = () => { let fullUrl = url.url; if (!/^https?:\/\//i.test(fullUrl)) { fullUrl = 'http://' + fullUrl; } window.open(fullUrl, '_blank', 'noopener,noreferrer'); }; const maliciousEngines = url.vtDetails ? Object.entries(url.vtDetails).filter(([_, result]) => result.category === 'malicious').map(([engine, _]) => engine) : []; return ( <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}> <div className="ios-modal-glass w-full max-w-2xl rounded-3xl animate-fade-in-scale" onClick={e => e.stopPropagation()}> <div className="p-6 max-h-[85vh] overflow-y-auto custom-scrollbar"> <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-[--text-main]">Test URL</h2><button onClick={onClose} className="p-1 rounded-full bg-[--bg-interactive] hover:opacity-80"><Icon path={ICONS.X} className="w-5 h-5"/></button></div> <div className="bg-black/20 p-4 rounded-lg mb-6"><p className="font-mono text-[--text-accent] break-all">{url.url}</p></div> {maliciousEngines.length > 0 && (<div className="mb-6"><h3 className="text-[--text-dim] mb-2">Flagged by ({maliciousEngines.length}):</h3><div className="bg-black/20 p-3 rounded-lg max-h-32 overflow-y-auto custom-scrollbar"><div className="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-1">{maliciousEngines.map(engine => <p key={engine} className="text-sm text-[--accent-negative] truncate" title={engine}>{engine}</p>)}</div></div></div>)} <div className="flex flex-col sm:flex-row gap-4"><button onClick={openUrl} className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-400 transition-transform hover:scale-105 shadow-lg shadow-indigo-500/20"><Icon path={ICONS.ExternalLink} className="w-5 h-5"/> Open in New Tab</button></div> <div className="mt-6 pt-6 border-t border-[--border-color]"><h3 className="text-center text-[--text-dim] mb-4">Mark test result as:</h3> <div className="grid grid-cols-1 sm:grid-cols-3 gap-4"> <StatusButton icon={<Icon path={ICONS.ShieldCheck}/>} text="Blocked" color="green" onClick={() => { onUpdateStatus(url.id, 'blocked'); onClose(); }} /> <StatusButton icon={<Icon path={ICONS.ShieldOff}/>} text="Missed" color="orange" onClick={() => { onUpdateStatus(url.id, 'missed'); onClose(); }} /> <StatusButton icon={<Icon path={ICONS.Skull}/>} text="Dead Link" color="purple" onClick={() => { onUpdateStatus(url.id, 'dead'); onClose(); }} /> </div> </div> </div> </div> </div> ); }
            const StatusButton = React.memo(({ icon, text, color, onClick }) => { const colorMap = { green: 'border-green-500/50 hover:bg-green-500/20 text-green-400', orange: 'border-orange-500/50 hover:bg-orange-500/20 text-orange-400', purple: 'border-purple-500/50 hover:bg-purple-500/20 text-purple-400' }; return <button onClick={onClick} className={`flex items-center justify-center gap-3 p-4 border-2 rounded-lg transition-all duration-200 transform hover:scale-105 hover:border-white/50 ${colorMap[color]}`}>{icon} {text}</button>; });
            
            function SettingsPanel({ onClose, productName, setProductName, onAddUrls, onClearAll, geminiApiKey, setGeminiApiKey, virusTotalApiKey, setVirusTotalApiKey, abuseIpDbApiKey, setAbuseIpDbApiKey, hybridAnalysisApiKey, setHybridAnalysisApiKey, cloudflareWorkerUrl, setCloudflareWorkerUrl, vtScanThreshold, setVtScanThreshold, vtDeduplication, setVtDeduplication, vtInterpretation, setVtInterpretation, aiBehaviourScoring, setAiBehaviourScoring, defaultAiResponseLength, setDefaultAiResponseLength, animationsEnabled, setAnimationsEnabled, showToast }) { 
                const [urlInput, setUrlInput] = useState(''); 
                const [urlType, setUrlType] = useState('phishing'); 
                const [showConfirm, setShowConfirm] = useState(false); 
                const [activeTab, setActiveTab] = useState('website-parsing');
                const handleAdd = () => { if (urlInput.trim()) { onAddUrls(urlInput, urlType); setUrlInput(''); } }; 
                const handleConfirmClear = () => { onClearAll(); setShowConfirm(false); }; 
                const handleExportState = () => {
                    const stateToSave = { geminiApiKey, virusTotalApiKey, abuseIpDbApiKey, hybridAnalysisApiKey, cloudflareWorkerUrl, productName, vtScanThreshold, vtDeduplication, vtInterpretation, aiBehaviourScoring, defaultAiResponseLength };
                    const blob = new Blob([JSON.stringify(stateToSave, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'dashboard-state.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
                const handleImportState = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const state = JSON.parse(e.target.result);
                                if (state.geminiApiKey) setGeminiApiKey(state.geminiApiKey);
                                if (state.virusTotalApiKey) setVirusTotalApiKey(state.virusTotalApiKey);
                                if (state.abuseIpDbApiKey) setAbuseIpDbApiKey(state.abuseIpDbApiKey);
                                if (state.hybridAnalysisApiKey) setHybridAnalysisApiKey(state.hybridAnalysisApiKey);
                                if (state.cloudflareWorkerUrl) setCloudflareWorkerUrl(state.cloudflareWorkerUrl);
                                if (state.productName) setProductName(state.productName);
                                if (state.vtScanThreshold) setVtScanThreshold(state.vtScanThreshold);
                                if (typeof state.vtDeduplication === 'boolean') setVtDeduplication(state.vtDeduplication);
                                if (typeof state.vtInterpretation === 'boolean') setVtInterpretation(state.vtInterpretation);
                                if (typeof state.aiBehaviourScoring === 'boolean') setAiBehaviourScoring(state.aiBehaviourScoring);
                                if (state.defaultAiResponseLength) setDefaultAiResponseLength(state.defaultAiResponseLength);
                                showToast("State imported successfully.");
                            } catch (error) {
                                showToast("Error importing state file.", 'error');
                                console.error("Import Error:", error);
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                return ( <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-end justify-center p-0 sm:p-4 animate-fade-in" onClick={onClose}> <div className="ios-modal-glass w-full max-w-3xl rounded-t-3xl sm:rounded-3xl animate-slide-up" onClick={e => e.stopPropagation()}> <div className="flex justify-center pt-3 pb-2"><div className="w-10 h-1.5 bg-gray-600 rounded-full"></div></div> <div className="p-6 max-h-[85vh] overflow-y-auto custom-scrollbar"> <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-[--text-main]">Settings</h2><button onClick={onClose} className="p-1 rounded-full bg-[--bg-interactive] hover:opacity-80"><Icon path={ICONS.X} className="w-5 h-5"/></button></div> 
                <div className="flex items-center gap-2 border-b border-[--border-color] mb-6 overflow-x-auto">
                    <button onClick={() => setActiveTab('website-parsing')} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors whitespace-nowrap ${activeTab === 'website-parsing' ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>Website Parsing</button>
                    <button onClick={() => setActiveTab('apis')} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors whitespace-nowrap ${activeTab === 'apis' ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>API & Security</button>
                    <button onClick={() => setActiveTab('virustotal')} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors whitespace-nowrap ${activeTab === 'virustotal' ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>VirusTotal</button>
                    <button onClick={() => setActiveTab('ai-behaviour')} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors whitespace-nowrap ${activeTab === 'ai-behaviour' ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>AI Behaviour</button>
                    <button onClick={() => setActiveTab('performance')} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors whitespace-nowrap ${activeTab === 'performance' ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>Performance</button>
                    <button onClick={() => setActiveTab('state')} className={`px-4 py-2 text-sm font-semibold capitalize transition-colors whitespace-nowrap ${activeTab === 'state' ? 'border-b-2 border-[--accent-primary] text-[--text-accent]' : 'text-[--text-dim] hover:text-[--text-main]'}`}>State Management</button>
                </div>
                <div className="min-h-[450px]">
                    {activeTab === 'website-parsing' && (<div>
                        <div className="mb-6"><label htmlFor="productName" className="block text-sm font-medium text-[--text-dim] mb-2">Product Name</label><input type="text" id="productName" value={productName} onChange={e => setProductName(e.target.value)} className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" /></div>
                        <div className="mb-4"><label htmlFor="urlParser" className="block text-sm font-medium text-[--text-dim] mb-2">Parse & Add URLs</label><p className="text-xs text-[--text-dim] mb-2">Paste a list of URLs, one per line.</p><textarea id="urlParser" rows="6" value={urlInput} onChange={e => setUrlInput(e.target.value)} placeholder="example.com/phishing-page&#10;another-evil-site.net/malware.exe" className="font-mono w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] text-sm focus:ring-2 focus:ring-[--accent-primary] focus:outline-none custom-scrollbar transition-shadow"></textarea></div> <div className="flex flex-col sm:flex-row items-center justify-between gap-4"> <div className="flex items-center gap-4"><span className="text-sm font-medium text-[--text-dim]">Categorize as:</span><div className="flex gap-2"><button onClick={() => setUrlType('phishing')} className={`px-4 py-2 rounded-md text-sm font-semibold transition-all ${urlType === 'phishing' ? 'bg-yellow-400 text-black shadow-lg shadow-yellow-500/20' : 'bg-[--bg-interactive] hover:opacity-80'}`}>Phishing</button><button onClick={() => setUrlType('malware')} className={`px-4 py-2 rounded-md text-sm font-semibold transition-all ${urlType === 'malware' ? 'bg-red-500 text-white shadow-lg shadow-red-500/20' : 'bg-[--bg-interactive] hover:opacity-80'}`}>Malware</button></div></div> <button onClick={handleAdd} className="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 bg-[--accent-primary] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 shadow-lg shadow-cyan-500/20 transform hover:scale-105"><Icon path={ICONS.Plus} className="w-5 h-5" /> Add URLs</button> </div>
                        <div className="mt-8 pt-6 border-t border-[--border-color]"><h3 className="text-lg font-semibold text-[--accent-negative] mb-2">Danger Zone</h3> {showConfirm ? (<div className="bg-red-500/20 p-4 rounded-lg"><p className="text-[--text-main] mb-3">Are you sure? This action cannot be undone.</p><div className="flex gap-4"><button onClick={handleConfirmClear} className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-md font-semibold">Yes, Clear All</button><button onClick={() => setShowConfirm(false)} className="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-md">Cancel</button></div></div>) : (<button onClick={() => setShowConfirm(true)} className="px-4 py-2 bg-red-600/50 hover:bg-red-600 text-white rounded-md text-sm font-semibold transition-colors">Clear All URLS</button>)} </div>
                    </div>)}
                    {activeTab === 'apis' && (<div>
                        <div className="mb-6"><label htmlFor="geminiKey" className="block text-sm font-medium text-[--text-dim] mb-2">Gemini API Key</label><input type="password" id="geminiKey" value={geminiApiKey} onChange={e => setGeminiApiKey(e.target.value)} className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" /></div>
                        <div className="mb-6"><label htmlFor="vtKey" className="block text-sm font-medium text-[--text-dim] mb-2">VirusTotal API Key</label><input type="password" id="vtKey" value={virusTotalApiKey} onChange={e => setVirusTotalApiKey(e.target.value)} className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" /></div>
                        <div className="mb-6"><label htmlFor="abuseIpDbKey" className="block text-sm font-medium text-[--text-dim] mb-2">AbuseIPDB API Key</label><input type="password" id="abuseIpDbKey" value={abuseIpDbApiKey} onChange={e => setAbuseIpDbApiKey(e.target.value)} className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" /></div>
                        <div className="mb-6"><label htmlFor="haKey" className="block text-sm font-medium text-[--text-dim] mb-2">Hybrid Analysis API Key</label><input type="password" id="haKey" value={hybridAnalysisApiKey} onChange={e => setHybridAnalysisApiKey(e.target.value)} className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" /></div>
                        <div className="mt-8 pt-6 border-t border-[--border-color]">
                            <h3 className="text-lg font-semibold text-teal-400 mb-2">Secure Mode</h3>
                            <p className="text-[--text-dim] text-sm mb-3">For enhanced privacy, route API calls through your own Cloudflare Worker instead of the public proxy.</p>
                            <label htmlFor="cfWorker" className="block text-sm font-medium text-[--text-dim] mb-2">Cloudflare Worker URL</label>
                            <input type="text" id="cfWorker" value={cloudflareWorkerUrl} onChange={e => setCloudflareWorkerUrl(e.target.value)} placeholder="https://my-worker.example.workers.dev" className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" />
                            <CloudflareWorkerSnippet />
                        </div>
                        <div className="mt-8 pt-6 border-t border-[--border-color]"><h3 className="text-lg font-semibold text-yellow-400 mb-2">Public CORS Proxy</h3><p className="text-[--text-dim] text-sm mb-3">If not using Secure Mode, you may need to activate the public proxy for API scans to work.</p><a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" rel="noopener noreferrer" className="inline-block px-4 py-2 bg-yellow-600/50 hover:bg-yellow-600 text-white rounded-md text-sm font-semibold transition-colors">Activate Proxy</a></div>
                    </div>)}
                    {activeTab === 'virustotal' && (<div>
                        <div className="mb-6"><label htmlFor="vtThreshold" className="block text-sm font-medium text-[--text-dim] mb-2">URL Detection Threshold</label><input type="number" id="vtThreshold" value={vtScanThreshold} onChange={e => setVtScanThreshold(parseInt(e.target.value, 10) || 1)} min="1" className="w-full bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-2 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" /></div>
                        <div className="bg-black/20 p-4 rounded-lg flex items-center justify-between mb-4">
                            <div><label htmlFor="dedupeToggle" className="font-medium text-[--text-main]">Deduplicate Detections</label><p className="text-xs text-[--text-dim]">Hide redundant detections from lower-tier engines.</p></div>
                            <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="dedupeToggle" className="sr-only peer" checked={vtDeduplication} onChange={e => setVtDeduplication(e.target.checked)} /><div className="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>
                        <div className="bg-black/20 p-4 rounded-lg flex items-center justify-between">
                            <div><label htmlFor="interpToggle" className="font-medium text-[--text-main]">Enable Interpretation Heuristic</label><p className="text-xs text-[--text-dim]">Calculate and display a threat score and commentary.</p></div>
                            <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="interpToggle" className="sr-only peer" checked={vtInterpretation} onChange={e => setVtInterpretation(e.target.checked)} /><div className="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>
                    </div>)}
                    {activeTab === 'ai-behaviour' && (<div>
                        <div className="bg-black/20 p-4 rounded-lg flex items-center justify-between">
                            <div><label htmlFor="aiScoreToggle" className="font-medium text-[--text-main]">Enable AI Behaviour Scoring</label><p className="text-xs text-[--text-dim]">Use Gemini to automatically score sandbox actions by risk.</p></div>
                            <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="aiScoreToggle" className="sr-only peer" checked={aiBehaviourScoring} onChange={e => setAiBehaviourScoring(e.target.checked)} /><div className="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>
                        <div className="bg-black/20 p-4 rounded-lg flex items-center justify-between mt-4">
                            <div>
                                <label className="font-medium text-[--text-main]">Default AI Analysis Level</label>
                                <p className="text-xs text-[--text-dim]">Set the default detail level for automatic and manual analysis.</p>
                            </div>
                            <div className="flex items-center gap-1 bg-black/40 p-1 rounded-lg">
                                <button onClick={() => setDefaultAiResponseLength('short')} className={`px-2 py-1 text-xs rounded-md ${defaultAiResponseLength === 'short' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Concise</button>
                                <button onClick={() => setDefaultAiResponseLength('medium')} className={`px-2 py-1 text-xs rounded-md ${defaultAiResponseLength === 'medium' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Balanced</button>
                                <button onClick={() => setDefaultAiResponseLength('expert')} className={`px-2 py-1 text-xs rounded-md ${defaultAiResponseLength === 'expert' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Expert</button>
                            </div>
                        </div>
                    </div>)}
                     {activeTab === 'performance' && (<div>
                        <div className="bg-black/20 p-4 rounded-lg flex items-center justify-between">
                            <div><label htmlFor="animToggle" className="font-medium text-[--text-main]">Enable Background Animations</label><p className="text-xs text-[--text-dim]">Disable for better performance on low-power devices.</p></div>
                            <label className="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="animToggle" className="sr-only peer" checked={animationsEnabled} onChange={e => setAnimationsEnabled(e.target.checked)} /><div className="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>
                    </div>)}
                    {activeTab === 'state' && (<div>
                        <h3 className="text-lg font-semibold text-indigo-400 mb-2">State Management</h3><p className="text-sm text-[--text-dim] mb-4">Export your current settings and API keys to a file, or import them to quickly set up a new session.</p><div className="flex gap-4"><button onClick={handleExportState} className="px-4 py-2 bg-indigo-600/50 hover:bg-indigo-600 text-white rounded-md text-sm font-semibold transition-colors">Export State</button><label className="px-4 py-2 bg-indigo-600/50 hover:bg-indigo-600 text-white rounded-md text-sm font-semibold transition-colors cursor-pointer">Import State<input type="file" accept=".json" className="hidden" onChange={handleImportState} /></label></div>
                    </div>)}
                </div>
                </div> </div> </div> ); }
            
            const LoadingTree = () => {const colors = ["#38bdf8", "#818cf8", "#c084fc", "#f471b5"];const [colorIndex, setColorIndex] = useState(0); useEffect(() => {const timer = setInterval(() => {setColorIndex(prevIndex => (prevIndex + 1) % colors.length);}, 500);return () => clearInterval(timer);}, []); return (<div className="flex flex-col items-center justify-center p-8"><svg width="100" height="100" viewBox="0 0 100 100" className="mb-4"><line x1="50" y1="90" x2="50" y2="70" stroke="#475569" strokeWidth="2" /><line x1="50" y1="70" x2="30" y2="50" stroke="#475569" strokeWidth="2" /><line x1="50" y1="70" x2="70" y2="50" stroke="#475569" strokeWidth="2" /><line x1="30" y1="50" x2="20" y2="30" stroke="#475569" strokeWidth="2" /><line x1="30" y1="50" x2="40" y2="30" stroke="#475569" strokeWidth="2" /><line x1="70" y1="50" x2="60" y2="30" stroke="#475569" strokeWidth="2" /><line x1="70" y1="50" x2="80" y2="30" stroke="#475569" strokeWidth="2" /><circle cx="50" cy="90" r="5" fill={colors[(colorIndex + 0) % 4]} className="transition-colors duration-500" /><circle cx="30" cy="50" r="5" fill={colors[(colorIndex + 1) % 4]} className="transition-colors duration-500" /><circle cx="70" cy="50" r="5" fill={colors[(colorIndex + 2) % 4]} className="transition-colors duration-500" /><circle cx="20" cy="30" r="5" fill={colors[(colorIndex + 3) % 4]} className="transition-colors duration-500" /><circle cx="40" cy="30" r="5" fill={colors[(colorIndex + 0) % 4]} className="transition-colors duration-500" /><circle cx="60" cy="30" r="5" fill={colors[(colorIndex + 1) % 4]} className="transition-colors duration-500" /><circle cx="80" cy="30" r="5" fill={colors[(colorIndex + 2) % 4]} className="transition-colors duration-500" /></svg><p className="text-[--text-dim] text-lg font-semibold animate-pulse">Analyzing results...</p></div>);};
            
            function AnalysisModal({ onClose, isLoading, stats, effectiveness, analysisResult }) {return (<div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}><div className="ios-modal-glass w-full max-w-2xl rounded-3xl animate-fade-in-scale" onClick={e => e.stopPropagation()}><div className="p-6"><div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-[--text-main]">AI Analysis</h2><button onClick={onClose} className="p-1 rounded-full bg-[--bg-interactive] hover:opacity-80"><Icon path={ICONS.X} className="w-5 h-5"/></button></div>{isLoading ? <LoadingTree /> : (<div><div className="grid grid-cols-2 gap-4 mb-6 text-center"><div className="bg-black/20 p-4 rounded-lg"><h3 className="text-sm text-[--text-dim] mb-1 tracking-wider uppercase">Effectiveness</h3><p className="text-4xl font-bold text-[--text-accent]">{effectiveness !== null ? effectiveness.toFixed(1) : '0.0'}%</p></div><div className="bg-black/20 p-4 rounded-lg"><h3 className="text-sm text-[--text-dim] mb-1 tracking-wider uppercase">URLs Tested</h3><p className="text-4xl font-bold text-[--text-main]">{stats.tested}</p></div><div className="bg-green-500/20 p-3 rounded-lg"><p className="text-green-300">{stats.blocked} Blocked</p></div><div className="bg-orange-500/20 p-3 rounded-lg"><p className="text-orange-300">{stats.missed} Missed</p></div></div><div className="bg-black/20 p-4 rounded-lg"><h3 className="font-semibold text-[--text-main] mb-2 flex items-center gap-2"><Icon path={ICONS.BrainCircuit} className="w-5 h-5 text-purple-400"/>Expert Commentary</h3><p className="text-[--text-dim] whitespace-pre-wrap">{analysisResult}</p></div></div>)}</div></div></div>);}

            function CadyModal({ onClose, geminiApiKey, vtResult, haResult, getProxyUrl }) {
                const [chatHistory, setChatHistory] = useState([
                    { role: 'cady', text: "Hello there, fellow analyst. I am CADY, your Cyber Analysis & Defense AI. How can I assist you with your current analysis?" }
                ]);
                const [userInput, setUserInput] = useState('');
                const [isLoading, setIsLoading] = useState(false);
                const [responseLength, setResponseLength] = useState('medium');
                const chatContainerRef = useRef(null);

                useEffect(() => {
                    if (chatContainerRef.current) {
                        chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                    }
                }, [chatHistory]);

                const handleSendMessage = async () => {
                    if (!userInput.trim() || isLoading) return;
                    if (!geminiApiKey) {
                         setChatHistory(prev => [...prev, { role: 'cady', text: "My apologies, but a Gemini API key is required for me to function. Please add one in the main settings panel." }]);
                         return;
                    }

                    const newHistory = [...chatHistory, { role: 'user', text: userInput }];
                    setChatHistory(newHistory);
                    setUserInput('');
                    setIsLoading(true);

                    const context = `
                        CONTEXT: You have the following intelligence reports for a file.
                        VirusTotal Report: ${JSON.stringify(vtResult)}
                        Hybrid Analysis Report: ${JSON.stringify(haResult)}
                    `;

                    const lengthInstruction = {
                        short: "Keep your response concise and to the point (1-2 sentences).",
                        medium: "Provide a balanced and moderately detailed response (a short paragraph).",
                        expert: "Provide a detailed and thorough expert-level response."
                    };

                    const prompt = `You are CADY (Cyber Analysis & Defense AI), an expert malware analyst and reverse engineer. Your tone is professional, concise, and helpful. You are assisting another analyst.
                    ${(vtResult || haResult) ? context : "CONTEXT: No file is currently loaded for analysis."}
                    ${lengthInstruction[responseLength]}
                    Based on the provided context and the conversation history, answer the following question: ${userInput}`;
                    
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const apiUrl = `${getProxyUrl()}https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error.message);
                        }
                        const result = await response.json();
                        const cadyResponse = result.candidates[0].content.parts[0].text;
                        setChatHistory(prev => [...prev, { role: 'cady', text: cadyResponse }]);
                    } catch (error) {
                        console.error("CADY API Error:", error);
                        setChatHistory(prev => [...prev, { role: 'cady', text: `I seem to be having trouble connecting. Error: ${error.message}` }]);
                    } finally {
                        setIsLoading(false);
                    }
                };

                return (
                    <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
                        <div className="ios-modal-glass w-full max-w-2xl rounded-3xl animate-fade-in-scale" onClick={e => e.stopPropagation()}>
                            <div className="p-6 max-h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center mb-4 flex-shrink-0">
                                    <div className="flex items-center gap-3">
                                        <Icon path={ICONS.Bot} className="w-8 h-8 text-[--text-accent]" />
                                        <h2 className="text-xl font-bold text-[--text-main]">CADY</h2>
                                    </div>
                                    <button onClick={onClose} className="p-1 rounded-full bg-[--bg-interactive] hover:opacity-80"><Icon path={ICONS.X} className="w-5 h-5"/></button>
                                </div>
                                <div ref={chatContainerRef} className="flex-grow bg-black/20 rounded-lg p-4 mb-4 overflow-y-auto custom-scrollbar space-y-4">
                                    {chatHistory.map((msg, index) => (
                                        <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-md p-3 rounded-2xl ${msg.role === 'user' ? 'bg-[--accent-primary] text-white rounded-br-none' : 'bg-[--bg-secondary] text-[--text-main] rounded-bl-none'}`}>
                                                <p className="text-sm whitespace-pre-wrap">{msg.text}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && (
                                        <div className="flex justify-start">
                                            <div className="max-w-md p-3 rounded-2xl bg-[--bg-secondary] text-[--text-main] rounded-bl-none">
                                                <Icon path={ICONS.Loader} className="w-5 h-5 animate-spin" />
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-xs text-[--text-dim]">Response Length:</span>
                                    <div className="flex items-center gap-1 bg-black/20 p-1 rounded-lg">
                                        <button onClick={() => setResponseLength('short')} className={`px-2 py-0.5 text-xs rounded-md ${responseLength === 'short' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Short</button>
                                        <button onClick={() => setResponseLength('medium')} className={`px-2 py-0.5 text-xs rounded-md ${responseLength === 'medium' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Medium</button>
                                        <button onClick={() => setResponseLength('expert')} className={`px-2 py-0.5 text-xs rounded-md ${responseLength === 'expert' ? 'bg-[--accent-primary] text-white' : 'text-[--text-dim]'}`}>Expert</button>
                                    </div>
                                </div>
                                <div className="flex-shrink-0 flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="Ask a question about this file..." 
                                        className="font-sans flex-grow bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-3 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow"
                                        value={userInput}
                                        onChange={(e) => setUserInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        disabled={isLoading}
                                    />
                                    <button onClick={handleSendMessage} disabled={isLoading} className="flex items-center justify-center gap-2 px-5 py-3 bg-[--accent-primary] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 shadow-lg shadow-cyan-500/20 transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                                        Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- New Components ---

            function IoCManagerView({ iocs, setIocs, showToast, virusTotalApiKey, abuseIpDbApiKey, getProxyUrl }) {
                const [newIoc, setNewIoc] = useState({ value: '', type: 'domain' });
                const [iocReputations, setIocReputations] = useState({});

                const handleAddIoc = (e) => {
                    e.preventDefault();
                    if (!newIoc.value.trim()) {
                        showToast('IoC value cannot be empty.', 'error');
                        return;
                    }
                    setIocs(prev => [...prev, { ...newIoc, id: crypto.randomUUID(), added: new Date().toISOString(), source: 'manual' }]);
                    setNewIoc({ value: '', type: 'domain' });
                    showToast('IoC added successfully.');
                };

                const handleRemoveIoc = (id) => {
                    setIocs(prev => prev.filter(ioc => ioc.id !== id));
                    showToast('IoC removed.', 'info');
                };
                
                const checkIocReputation = useCallback(async (value, type) => {
                    setIocReputations(prev => ({...prev, [value]: { isLoading: true }}));
                    const PROXY_URL = getProxyUrl();
                    let endpoint, headers, source;

                    if (type === 'ip' && abuseIpDbApiKey) {
                        endpoint = `${PROXY_URL}https://api.abuseipdb.com/api/v2/check?ipAddress=${encodeURIComponent(value)}`;
                        headers = { 'Key': abuseIpDbApiKey, 'Accept': 'application/json' };
                        source = 'abuseipdb';
                    } else if (type === 'domain' && virusTotalApiKey) {
                        endpoint = `${PROXY_URL}https://www.virustotal.com/api/v3/domains/${value}`;
                        headers = { 'x-apikey': virusTotalApiKey };
                        source = 'virustotal';
                    } else {
                        setIocReputations(prev => ({...prev, [value]: { error: "API Key Missing or Type not supported" }}));
                        return;
                    }

                    try {
                        const response = await fetch(endpoint, { headers });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.errors?.[0]?.detail || errorData.error?.message || `API Error (${response.status})`);
                        }
                        const result = await response.json();
                        setIocReputations(prev => ({...prev, [value]: { source, data: source === 'abuseipdb' ? result.data : result.data.attributes }}));
                    } catch (error) {
                        setIocReputations(prev => ({...prev, [value]: { error: error.message }}));
                    }
                }, [abuseIpDbApiKey, virusTotalApiKey, getProxyUrl]);


                const exportIocs = (format) => {
                    if (iocs.length === 0) {
                        showToast('No IoCs to export.', 'info');
                        return;
                    }
                    let data, mimeType, filename;
                    if (format === 'json') {
                        data = JSON.stringify(iocs, null, 2);
                        mimeType = 'application/json';
                        filename = 'iocs.json';
                    } else { // csv
                        const header = 'value,type,source,added\n';
                        const rows = iocs.map(i => `"${i.value}","${i.type}","${i.source}","${i.added}"`).join('\n');
                        data = header + rows;
                        mimeType = 'text/csv';
                        filename = 'iocs.csv';
                    }
                    const blob = new Blob([data], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                return (
                    <div className="animate-fade-in h-[calc(100vh-150px)] flex flex-col">
                        <div className="mb-6 flex-shrink-0">
                            <h2 className="text-3xl font-bold text-[--text-main]">Indicator of Compromise Manager</h2>
                            <p className="text-[--text-dim] mt-1">Collect, manage, and export IoCs from your analyses.</p>
                        </div>
                        <form onSubmit={handleAddIoc} className="flex gap-2 mb-4 flex-shrink-0">
                            <input type="text" value={newIoc.value} onChange={e => setNewIoc(prev => ({...prev, value: e.target.value}))} placeholder="Enter IoC value..." className="font-mono flex-grow bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-3 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow" />
                            <select value={newIoc.type} onChange={e => setNewIoc(prev => ({...prev, type: e.target.value}))} className="bg-[--bg-interactive] border border-[--border-color] rounded-lg px-4 py-3 text-[--text-main] focus:ring-2 focus:ring-[--accent-primary] focus:outline-none transition-shadow">
                                <option value="domain">Domain</option>
                                <option value="ip">IP Address</option>
                                <option value="hash-md5">MD5</option>
                                <option value="hash-sha1">SHA1</option>
                                <option value="hash-sha256">SHA256</option>
                                <option value="url">URL</option>
                                <option value="filepath">File Path</option>
                                <option value="registry">Registry Key</option>
                                <option value="command">Command</option>
                            </select>
                            <button type="submit" className="flex items-center justify-center gap-2 px-5 py-3 bg-[--accent-primary] text-white font-semibold rounded-lg hover:opacity-80 transition-all duration-300 shadow-lg shadow-cyan-500/20 transform hover:scale-105">Add</button>
                        </form>
                        <div className="flex-grow overflow-y-auto custom-scrollbar bg-black/20 rounded-lg">
                            {iocs.length === 0 ? (
                                <div className="flex items-center justify-center h-full text-[--text-dim]">No IoCs collected yet.</div>
                            ) : (
                                <table className="w-full text-sm">
                                    <thead className="sticky top-0 bg-[--bg-secondary] z-10">
                                        <tr>
                                            <th className="p-3 text-left text-[--text-dim] font-semibold">Value</th>
                                            <th className="p-3 text-left text-[--text-dim] font-semibold">Type</th>
                                            <th className="p-3 text-left text-[--text-dim] font-semibold">Source</th>
                                            <th className="p-3 text-left text-[--text-dim] font-semibold">Date Added</th>
                                            <th className="p-3 text-right text-[--text-dim] font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {iocs.map(ioc => (
                                            <tr key={ioc.id} className="border-t border-[--border-color]">
                                                <td className="p-3 font-mono break-all">{ioc.value}</td>
                                                <td className="p-3"><span className="px-2 py-1 text-xs font-medium rounded-full bg-indigo-500/20 text-indigo-300">{ioc.type}</span></td>
                                                <td className="p-3 font-mono text-xs break-all" title={ioc.source}>{ioc.source === 'manual' ? 'Manual' : ioc.source.substring(0, 12) + '...'}</td>
                                                <td className="p-3 text-xs text-[--text-dim]">{new Date(ioc.added).toLocaleString()}</td>
                                                <td className="p-3 text-right flex items-center justify-end">
                                                    {(ioc.type === 'ip' || ioc.type === 'domain') && (
                                                        <ReputationChecker 
                                                            reputation={iocReputations[ioc.value]} 
                                                            onCheck={(e) => {
                                                                e.stopPropagation();
                                                                checkIocReputation(ioc.value, ioc.type);
                                                            }} 
                                                        />
                                                    )}
                                                    <button onClick={() => handleRemoveIoc(ioc.id)} className="p-1 text-red-400 hover:text-red-300">
                                                        <Icon path={ICONS.X} className="w-4 h-4" />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                        <div className="flex-shrink-0 mt-4 flex justify-end gap-2">
                            <button onClick={() => exportIocs('csv')} className="px-4 py-2 bg-green-600/50 hover:bg-green-600 text-white rounded-md text-sm font-semibold transition-colors">Export as CSV</button>
                            <button onClick={() => exportIocs('json')} className="px-4 py-2 bg-blue-600/50 hover:bg-blue-600 text-white rounded-md text-sm font-semibold transition-colors">Export as JSON</button>
                        </div>
                    </div>
                );
            }

            function BehaviourGroupAccordion({ title, actions, addIoc, sourceHash }) {
                const [isOpen, setIsOpen] = useState(false);
                
                return (
                    <div className="rounded-lg border border-[--border-color] bg-[--bg-secondary]/50 overflow-hidden">
                        <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between p-3 text-left">
                            <div className="flex items-center gap-3">
                                <span className="font-semibold capitalize text-[--text-main]">{title.replace(/([A-Z])/g, ' $1').trim()}</span>
                                <span className="text-sm text-[--text-dim]">({actions.length} actions)</span>
                            </div>
                            <Icon path={ICONS.Plus} className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-45' : ''}`} />
                        </button>
                        {isOpen && (
                            <div className="p-3 border-t border-white/10 bg-black/20 space-y-2">
                                {actions.map(action => (
                                    <div key={action.id} className="p-2 rounded-md bg-black/20">
                                        <p className="font-semibold text-sm text-[--text-main]">{action.title}</p>
                                        <p className="font-mono text-xs text-[--text-dim] break-all">{action.content}</p>
                                        {action.ioc && (
                                            <button onClick={() => addIoc({ ...action.ioc, source: sourceHash })} className="mt-1 text-xs flex items-center gap-1 text-sky-400 hover:text-sky-300">
                                                <Icon path={ICONS.Plus} className="w-3 h-3" /> Add to IoC Manager
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            }
            
            function IocTable({ title, iocs, addIoc, sourceHash, iocReputations, onCheckReputation }) {
                if (!iocs || iocs.length === 0) return null;
                return (
                    <div className="mb-6">
                        <h3 className="text-lg font-semibold text-[--text-accent] mb-2">{title}</h3>
                        <div className="bg-black/20 rounded-lg">
                            <table className="w-full text-sm table-fixed">
                                <tbody>
                                    {iocs.map((item, index) => (
                                        <tr key={index} className="border-b border-[--border-color] last:border-b-0">
                                            <td className="p-3 font-mono text-[--text-main] break-all flex justify-between items-start gap-2">
                                                <span className="flex-1">{item.value}</span>
                                                <div className="flex items-center">
                                                    <ReputationChecker 
                                                        reputation={iocReputations[item.value]} 
                                                        onCheck={(e) => {
                                                            e.stopPropagation();
                                                            onCheckReputation(item.value, item.type);
                                                        }} 
                                                    />
                                                    <button onClick={() => addIoc({ ...item, source: sourceHash })} className="p-1 text-[--text-dim] hover:text-[--text-main]" title="Add to IoC Manager"><Icon path={ICONS.Plus} className="w-4 h-4" /></button>
                                                    <CopyButton textToCopy={item.value} />
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };
            
            function VtInterpretationWidget({ info }) {
                const scoreColor = info.score > 80 ? 'text-red-500' : info.score > 50 ? 'text-orange-400' : info.score > 20 ? 'text-yellow-400' : 'text-sky-400';
                return (
                    <div className="bg-black/20 p-4 rounded-lg mb-4">
                        <h3 className="text-sm font-semibold text-[--text-dim] mb-2">Interpretation Heuristic</h3>
                        <div className="flex items-center gap-4">
                            <div className="text-center">
                                <p className={`text-4xl font-bold ${scoreColor}`}>{info.score}</p>
                                <p className="text-xs text-[--text-dim]">Threat Score</p>
                            </div>
                            <p className="text-sm text-[--text-main] flex-1">{info.comment}</p>
                        </div>
                    </div>
                );
            }

            function AiSummaryWidget({ title, score, summary, scoreLabel = "Score" }) {
                if (score === null || score === undefined) return null;
                const scoreColor = score > 75 ? 'text-red-500' : score > 50 ? 'text-orange-400' : 'text-sky-400';
                const verdictText = summary === 'Malicious' ? 'Looks Malicious' : summary;

                return (
                       <div className="bg-black/20 p-4 rounded-lg mb-4">
                            <h3 className="text-sm font-semibold text-[--text-dim] mb-2">{title}</h3>
                            <div className="flex items-center gap-4">
                                <div className="text-center">
                                    <p className={`text-4xl font-bold ${scoreColor}`}>{score}</p>
                                    <p className="text-xs text-[--text-dim]">{scoreLabel}</p>
                                </div>
                                <p className={`text-xl font-bold flex-1 ${scoreColor}`}>{verdictText}</p>
                            </div>
                        </div>
                );
            }

            function MitreGridMatrix({ matrix }) {
                const tactics = [ "Reconnaissance", "Resource Development", "Initial Access", "Execution", "Persistence", "Privilege Escalation", "Defense Evasion", "Credential Access", "Discovery", "Lateral Movement", "Collection", "Command and Control", "Exfiltration", "Impact" ];
                
                return (
                    <div className="overflow-x-auto custom-scrollbar bg-black/20 p-2 rounded-lg text-base">
                        <div className="grid" style={{ gridTemplateColumns: `repeat(${tactics.length}, minmax(160px, 1fr))`}}>
                            {tactics.map(tactic => (
                                <div key={tactic} className="text-center border-r border-[--border-color] last:border-r-0">
                                    <h4 className="text-sm font-bold p-3 border-b border-[--border-color] whitespace-nowrap sticky top-0 bg-[--bg-secondary] z-10">{tactic}</h4>
                                    <div className="p-2 space-y-2">
                                        {(matrix[tactic] || []).map(tech => (
                                            <div key={tech.technique} className="relative matrix-cell">
                                                <a 
                                                    href={`https://attack.mitre.org/techniques/${tech.technique.replace('.', '/')}/`}
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="block bg-rose-500/50 text-white text-sm font-mono p-2 rounded cursor-pointer hover:bg-rose-500/80 transition-colors"
                                                    title={`${tech.techniqueName}\nClick to view on MITRE ATT&CK`}
                                                >
                                                    {tech.technique}
                                                </a>
                                                <div className="matrix-tooltip absolute bottom-full mb-2 left-1/2 -translate-x-1/2">
                                                    <p className="font-bold text-[--text-main]">{tech.techniqueName}</p>
                                                    <p className="text-[--text-dim] mt-1 text-sm">{tech.justification}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            function SourcePromptModal({ isOpen, onSubmit }) {
                if (!isOpen) return null;

                const sources = [
                    { id: 'email', label: 'Email Attachment', stance: 'Aggressive' },
                    { id: 'untrusted', label: 'Untrusted Website', stance: 'Aggressive' },
                    { id: 'trusted', label: 'Trusted Website', stance: 'Standard' },
                    { id: 'other', label: 'Other / Unknown', stance: 'Standard' }
                ];

                return (
                    <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="ios-modal-glass w-full max-w-lg rounded-3xl animate-fade-in-scale" onClick={e => e.stopPropagation()}>
                            <div className="p-6 text-center">
                                <Icon path={ICONS.Info} className="w-12 h-12 text-[--text-accent] mx-auto mb-4" />
                                <h2 className="text-xl font-bold text-[--text-main] mb-2">Analysis Context</h2>
                                <p className="text-[--text-dim] mb-6">Where did this file come from? This context helps tailor the behavioral analysis.</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {sources.map(source => (
                                        <button 
                                            key={source.id} 
                                            onClick={() => onSubmit(source.id)} 
                                            className="p-4 rounded-lg bg-[--bg-interactive] hover:bg-[--accent-primary]/20 transition-colors text-left"
                                        >
                                            <p className="font-semibold text-[--text-main]">{source.label}</p>
                                            <p className="text-xs text-[--text-dim]">{source.stance} Analysis Stance</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            function CloudflareWorkerSnippet() {
                const code = `
    const API_KEYS = {
      'generativelanguage.googleapis.com': 'YOUR_GEMINI_API_KEY',
      'www.virustotal.com': 'YOUR_VIRUSTOTAL_API_KEY',
      'www.hybrid-analysis.com': 'YOUR_HYBRID_ANALYSIS_API_KEY',
      'api.abuseipdb.com': 'YOUR_ABUSEIPDB_API_KEY',
    };

    export default {
      async fetch(request, env, ctx) {
        const url = new URL(request.url);
        const actualUrl = url.pathname.substring(1) + url.search;
        const actualUrlObj = new URL(actualUrl);
        const hostname = actualUrlObj.hostname;

        let response;
        let headers = new Headers(request.headers);
        headers.delete('Host');
        headers.delete('Referer');

        if (API_KEYS[hostname]) {
          if (hostname === 'www.virustotal.com' || hostname === 'generativelanguage.googleapis.com') {
            headers.set('x-apikey', API_KEYS[hostname]);
          } else if (hostname === 'www.hybrid-analysis.com') {
            headers.set('api-key', API_KEYS[hostname]);
          } else if (hostname === 'api.abuseipdb.com') {
            headers.set('Key', API_KEYS[hostname]);
          }
        }
        
        const newRequest = new Request(actualUrl, {
          method: request.method,
          headers: headers,
          body: request.body,
          redirect: 'follow'
        });

        response = await fetch(newRequest);
        
        let newResponseHeaders = new Headers(response.headers);
        newResponseHeaders.set('Access-Control-Allow-Origin', '*');
        newResponseHeaders.set('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
        newResponseHeaders.set('Access-Control-Allow-Headers', 'Content-Type, x-apikey, api-key, Key');

        return new Response(response.body, {
          status: response.status,
          statusText: response.statusText,
          headers: newResponseHeaders
        });
      },
    };`;

                return (
                    <div className="mt-4">
                        <p className="text-sm text-[--text-dim] mb-2">Copy this code into your Cloudflare Worker:</p>
                        <div className="relative bg-black/30 p-4 rounded-lg font-mono text-xs text-slate-300">
                            <CopyButton textToCopy={code} />
                            <pre className="overflow-x-auto custom-scrollbar">
                                <code>{code.trim()}</code>
                            </pre>
                        </div>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        }

        window.onload = runApplication;
    </script>
</body>
</html>
